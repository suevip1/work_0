<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dtstack.engine.dao.ScheduleJobDao">

    <!--字段过长不需要通用  -->
    <sql id="select_content_fragment">
      bj.id,bj.tenant_id,bj.project_id,bj.dtuic_tenant_id,bj.app_type,bj.job_id,bj.job_key,bj.job_name,bj.task_id,bj.gmt_create,bj.gmt_modified,bj.create_user_id,bj.is_deleted,bj.type,bj.is_restart,
      bj.business_date,bj.cyc_time,dependency_type,flow_job_id,bj.period_type,bj.status,bj.task_type,bj.fill_id,bj.exec_start_time,bj.exec_end_time,bj.exec_time,bj.submit_time,bj.retry_num, max_retry_num, retry_type,
      bj.node_address,bj.version_id,bj.next_cyc_time,bj.compute_type,bj.submit_user_name,bj.engine_job_id,bj.task_rule,bj.business_type,bj.fill_type,bj.resource_id,bj.job_build_type,bj.job_execute_order
    </sql>

    <sql id="select_filed_all">
        `id`,`tenant_id`,`project_id`,`dtuic_tenant_id`,`app_type`,`job_id`,`job_key`,`job_name`,`task_id`,`gmt_create`,`gmt_modified`,`create_user_id`,`is_deleted`,`type`,`is_restart`,`business_date`,`cyc_time`
        ,`dependency_type`,`flow_job_id`,`period_type`,`status`,`task_type`,`fill_id`,`exec_start_time`,`exec_end_time`,`exec_time`,`submit_time`,`max_retry_num`,`retry_num`, `retry_type`,`node_address`,`version_id`
        ,`next_cyc_time`,`engine_job_id`,`application_id`,`compute_type`,`phase_status`,`submit_user_name`,`business_type`,`fill_type`,`resource_id`,`job_build_type`,`job_execute_order`
    </sql>

    <sql id="select_filed_all_bj">
        id,tenant_id,project_id,dtuic_tenant_id,app_type,job_id,job_key,job_name,task_id,gmt_create,gmt_modified,create_user_id,is_deleted,type,is_restart,business_date,cyc_time,dependency_type,flow_job_id,period_type,status,task_type,fill_id,exec_start_time,exec_end_time,exec_time,submit_time,retry_num,max_retry_num,retry_type,node_address,version_id,next_cyc_time,compute_type,submit_user_name,engine_job_id,task_rule
        ,business_type,fill_type,resource_id,job_build_type,job_execute_order
    </sql>

    <sql id="select_where_fragment">
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="model.id != null and model.id > 0">
                AND bj.id = #{model.id}
            </if>
            <if test="model.tenantId != null">
                AND bj.tenant_id = #{model.tenantId}
            </if>
            <if test="model.dtuicTenantId != null and model.dtuicTenantId!=0">
                AND bj.dtuic_tenant_id = #{model.dtuicTenantId}
            </if>
            <if test="model.projectId != null and model.projectId != -1">
                AND bj.project_id = #{model.projectId}
            </if>
            <if test="model.jobId != null">
                AND bj.job_id = #{model.jobId}
            </if>
            <if test="model.jobKey != null">
                AND bj.job_key = #{model.jobKey}
            </if>
            <if test="model.jobName != null">
                AND bj.job_name = #{model.jobName}
            </if>
            <if test="model.taskId != null">
                AND bj.task_id = #{model.taskId}
            </if>
            <if test="model.gmtCreate != null">
                AND bj.gmt_create = #{model.gmtCreate}
            </if>
            <if test="model.gmtModified != null">
                AND bj.gmt_modified = #{model.gmtModified}
            </if>
            <if test="model.createUserId != null">
                AND bj.create_user_id = #{model.createUserId}
            </if>
            <if test="model.isDeleted != null">
                AND bj.is_deleted = #{model.isDeleted}
            </if>
            <if test="model.type != null">
                AND bj.type = #{model.type}
            </if>
            <if test="model.isRestart != null">
                AND bj.is_restart = #{model.isRestart}
            </if>
            <if test="model.businessDate != null">
                AND bj.business_date = #{model.businessDate}
            </if>
            <if test="model.likeBusinessDate != null">
                AND bj.business_date like '${model.likeBusinessDate}%'
            </if>
            <if test="model.cycTime != null">
                AND bj.cyc_time = #{model.cycTime}
            </if>
            <if test="model.taskId != null and model.taskIds.size() > 0">
                AND bj.task_id IN
                <foreach item="taskId" index="index" collection="model.taskIds" open="(" separator="," close=")">
                    #{taskId}
                </foreach>
            </if>
            <if test="model.jobStatuses != null and model.jobStatuses.size() > 0">
                AND bj.status IN
                <foreach item="status" index="index" collection="model.jobStatuses" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>

            <if test="model.types != null and model.types.size() > 0">
                AND bj.type IN
                <foreach item="type" index="index" collection="model.types" open="(" separator="," close=")">
                    #{type}
                </foreach>
            </if>

            <if test="model.execTime != null">
                AND bj.exec_time &gt;= #{model.execTime}
            </if>

            <if test="model.taskTypes != null and model.taskTypes.size() > 0">
                AND bj.task_type IN
                <foreach item="item" index="index" collection="model.taskTypes" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="model.cycStartDay != null and model.cycEndDay != null">
                AND bj.cyc_time <![CDATA[>=]]> #{model.cycStartDay}
                and bj.cyc_time <![CDATA[<]]> #{model.cycEndDay}
            </if>
            <if test="model.jobNameRightLike != null">
                AND bj.job_name LIKE '${model.jobNameRightLike}%'
            </if>

            <if test="model.startGmtCreate != null">
                AND to_days(bj.gmt_create) = to_days(#{model.startGmtCreate})
            </if>
            <if test="model.taskPeriodId != null and model.taskPeriodId.size()>0">
                AND bj.period_type IN
                <foreach collection="model.taskPeriodId" separator="," index="index" item="item" open="(" close=")">
                    ${item}
                </foreach>
            </if>

            <if test="model.flowJobId != null">
                AND bj.flow_job_id = #{model.flowJobId}
            </if>
            <if test="model.needQuerySonNode == false and model.flowJobId == null">
                AND bj.flow_job_id = 0
            </if>
            <if test="model.appType != null">
                AND bj.app_type = #{model.appType}
            </if>
            <if test="model.execStartDay != null and model.execEndDay != null">
                AND bj.exec_start_time &gt;= #{model.execStartDay} and bj.exec_start_time &lt;= #{model.execEndDay}
            </if>
            <if test="model.bizEndDay != null and model.bizStartDay != null">
                AND bj.business_date &gt;= #{model.bizStartDay} and bj.business_date &lt;= #{model.bizEndDay}
            </if>
            <if test="model.businessType != null">
                AND bj.business_type = #{model.businessType}
            </if>
            <if test="model.ownerUserId != null">
                AND bj.task_id IN (
                    SELECT ts.task_id FROM schedule_task_shade ts
                      WHERE ts.task_id = bj.task_id
                        <if test="model.appType != null">
                          AND ts.app_type = bj.app_type
                        </if>
                      AND ts.owner_user_id = #{model.ownerUserId}
                )
            </if>
            <if test="@org.apache.commons.collections.CollectionUtils@isNotEmpty(model.ownerUserIds)">
                AND bj.task_id IN (
                  SELECT ts.task_id FROM schedule_task_shade ts
                 WHERE ts.task_id = bj.task_id
                    <if test="model.appType != null">
                        AND ts.app_type = bj.app_type
                    </if>
                    AND ts.owner_user_id in
                    <foreach close=")" collection="model.ownerUserIds" index="idx" item="item" open="(" separator=",">
                        #{item}
                    </foreach>
                )
            </if>
            <if test="model.computeType != null">
                AND bj.compute_type = #{model.computeType}
            </if>
            <if test="model.resourceId != null">
                AND bj.resource_id = #{model.resourceId}
            </if>
            <if test="model.jobBuildType != null">
                AND bj.job_build_type = #{model.jobBuildType}
            </if>

            <if test="model.resourceIds != null and model.resourceIds.size()>0">
                AND bj.resource_id IN
                <foreach collection="model.resourceIds" separator="," index="index" item="item" open="(" close=")">
                    ${item}
                </foreach>
            </if>
        </trim>
    </sql>

    <sql id="select_where_fragment_without_ts">
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="model.id != null and model.id > 0">
                AND bj.id = #{model.id}
            </if>
            <if test="model.tenantId != null">
                AND bj.tenant_id = #{model.tenantId}
            </if>
            <if test="model.projectId != null">
                AND bj.project_id = #{model.projectId}
            </if>
            <if test="model.jobId != null">
                AND bj.job_id = #{model.jobId}
            </if>
            <if test="model.jobKey != null">
                AND bj.job_key = #{model.jobKey}
            </if>
            <if test="model.jobName != null">
                AND bj.job_name = #{model.jobName}
            </if>
            <if test="model.taskId != null">
                AND bj.task_id = #{model.taskId}
            </if>
            <if test="model.gmtCreate != null">
                AND bj.gmt_create = #{model.gmtCreate}
            </if>
            <if test="model.gmtModified != null">
                AND bj.gmt_modified = #{model.gmtModified}
            </if>
            <if test="model.createUserId != null">
                AND bj.create_user_id = #{model.createUserId}
            </if>
            <if test="model.isDeleted != null">
                AND bj.is_deleted = #{model.isDeleted}
            </if>
            <if test="model.type != null">
                AND bj.type = #{model.type}
            </if>
            <if test="model.isRestart != null">
                AND bj.is_restart = #{model.isRestart}
            </if>
            <if test="model.businessDate != null">
                AND bj.business_date = #{model.businessDate}
            </if>
            <if test="model.likeBusinessDate != null">
                AND bj.business_date like '${model.likeBusinessDate}%'
            </if>
            <if test="model.cycTime != null">
                AND bj.cyc_time = #{model.cycTime}
            </if>
            <if test="model.taskIds != null and model.taskIds.size() > 0">
                AND bj.task_id IN
                <foreach item="taskId" index="index" collection="model.taskIds" open="(" separator="," close=")">
                    #{taskId}
                </foreach>
            </if>
            <if test="model.jobStatuses != null and model.jobStatuses.size() > 0">
                AND bj.status IN
                <foreach item="status" index="index" collection="model.jobStatuses" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>

            <if test="model.execTime != null">
                AND bj.exec_time &gt;= #{model.execTime}
            </if>

            <if test="model.jobNameRightLike != null">
                AND bj.job_name LIKE '${model.jobNameRightLike}%'
            </if>
            <if test="model.bizStartDay != null and model.bizEndDay != null">
                AND bj.business_date &gt;= ${model.bizStartDay} and bj.business_date &lt; ${model.bizEndDay}
            </if>

            <if test="model.startGmtCreate != null">
                AND to_days(bj.gmt_create) = to_days(#{model.startGmtCreate})
            </if>
            <if test="model.taskPeriodId != null and model.taskPeriodId.size()>0">
                AND bj.period_type IN
                <foreach collection="model.taskPeriodId" separator="," index="index" item="item" open="(" close=")">
                    ${item}
                </foreach>
            </if>
            <if test="model.cycStartDay != null and model.cycEndDay != null">
                AND bj.cyc_time &gt;= ${model.cycStartDay} and bj.cyc_time &lt;= ${model.cycEndDay}
            </if>

            <if test="model.flowJobId != null">
                AND bj.flow_job_id = #{model.flowJobId}
            </if>
            <if test="model.appType != null">
                AND bj.app_type = #{model.appType}
            </if>
            <if test="model.jobBuildType != null">
                AND bj.job_build_type = #{model.jobBuildType}
            </if>

            <if test="model.types != null and model.types.size() > 0">
                AND bj.type IN
                <foreach item="type" index="index" collection="model.types" open="(" separator="," close=")">
                    #{type}
                </foreach>
            </if>
        </trim>
    </sql>

    <sql id="select_where_batch_job">
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            <if test="model.id != null and model.id > 0">
                AND id = #{model.id}
            </if>
            <if test="model.tenantId != null">
                AND tenant_id = #{model.tenantId}
            </if>
            <if test="model.dtuicTenantId != null and model.dtuicTenantId!=0">
                AND dtuic_tenant_id = #{model.dtuicTenantId}
            </if>
            <if test="model.projectId != null">
                AND project_id = #{model.projectId}
            </if>
            <if test="model.jobId != null">
                AND job_id = #{model.jobId}
            </if>
            <if test="model.jobKey != null">
                AND job_key = #{model.jobKey}
            </if>
            <if test="model.jobName != null">
                AND job_name = #{model.jobName}
            </if>
            <if test="model.taskId != null">
                AND task_id = #{model.taskId}
            </if>
            <if test="model.gmtCreate != null">
                AND gmt_create = #{model.gmtCreate}
            </if>
            <if test="model.gmtModified != null">
                AND gmt_modified = #{model.gmtModified}
            </if>
            <if test="model.createUserId != null">
                AND create_user_id = #{model.createUserId}
            </if>
            <if test="model.isDeleted != null">
                AND is_deleted = #{model.isDeleted}
            </if>
            <if test="model.type != null">
                AND type = #{model.type}
            </if>
            <if test="model.isRestart != null">
                AND is_restart = #{model.isRestart}
            </if>
            <if test="model.businessDate != null">
                AND business_date = #{model.businessDate}
            </if>
            <if test="model.likeBusinessDate != null">
                AND business_date like '${model.likeBusinessDate}%'
            </if>
            <if test="model.cycTime != null">
                AND cyc_time = #{model.cycTime}
            </if>
            <if test="model.appType != null">
                AND app_type = #{model.appType}
            </if>
            <if test="model.jobBuildType != null">
                AND job_build_type = #{model.jobBuildType}
            </if>

            <if test="model.taskIds != null and model.taskIds.size() > 0">
                AND task_id IN
                <foreach item="taskId" index="index" collection="model.taskIds" open="(" separator="," close=")">
                    #{taskId}
                </foreach>
            </if>
            <if test="model.jobStatuses != null and model.jobStatuses.size() > 0">
                AND status IN
                <foreach item="status" index="index" collection="model.jobStatuses" open="(" separator="," close=")">
                    #{status}
                </foreach>
            </if>
            <if test="model.taskTypes != null and model.taskTypes.size() > 0">
                AND task_type IN
                <foreach item="item" index="index" collection="model.taskTypes" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="model.jobNameRightLike != null">
                AND job_name LIKE '${model.jobNameRightLike}%'
            </if>
            <if test="model.bizStartDay != null and model.bizEndDay != null">
                AND business_date &gt;= ${model.bizStartDay} and business_date &lt; ${model.bizEndDay}
            </if>

            <if test="model.startGmtCreate != null">
                AND to_days(gmt_create) = to_days(#{model.startGmtCreate})
            </if>
            <if test="model.taskPeriodId != null and model.taskPeriodId.size()>0">
                AND period_type IN
                <foreach collection="model.taskPeriodId" separator="," index="index" item="item" open="(" close=")">
                    ${item}
                </foreach>
            </if>

            <if test="model.cycStartDay != null and model.cycEndDay != null">
                AND cyc_time <![CDATA[>=]]> #{model.cycStartDay}
                AND cyc_time <![CDATA[<]]> #{model.cycEndDay}
            </if>

            <if test="model.flowJobId != null">
                AND flow_job_id = #{model.flowJobId}
            </if>
            <if test="model.queryWorkFlowModel == 1">
                AND flow_job_id = "0"
            </if>
            <if test="model.queryWorkFlowModel == 2">
                AND flow_job_id != "0"
            </if>
            <if test="model.queryWorkFlowModel == 4">
                AND task_type != 10
            </if>
            <if test="model.projectIds != null and model.projectIds.size()>0">
                AND project_id in
                <foreach collection="model.projectIds" open="(" close=")" separator="," item="projectId">
                    #{projectId}
                </foreach>
            </if>
            <if test="model.execStartDay != null and model.execEndDay != null">
                AND exec_start_time &gt;= ${model.execStartDay} and exec_start_time &lt;= ${model.execEndDay}
            </if>
            <if test="model.execEndTimeStart != null and model.execEndTimeEnd != null">
                AND exec_end_time &gt;= #{model.execEndTimeStart} and exec_end_time &lt;= #{model.execEndTimeEnd}
            </if>
            <if test="model.types != null and model.types.size() > 0">
                AND type IN
                <foreach item="type" index="index" collection="model.types" open="(" separator="," close=")">
                    #{type}
                </foreach>
            </if>
            <if test="model.computeType != null">
                AND compute_type = #{model.computeType}
            </if>
            <if test="model.businessType != null">
                AND business_type = #{model.businessType}
            </if>
            <if test="model.fillId != null">
                AND fill_id = #{model.fillId}
            </if>
            AND fill_type IN (0,1)
        </trim>
    </sql>


    <sql id="page_condition">
        <trim prefix="ORDER BY " prefixOverrides=",">
            <if test="model.execTimeSort != null and model.execTimeSort != ''">
                , bj.exec_time ${model.execTimeSort}
            </if>
            <if test="model.execStartSort != null and model.execStartSort != ''">
                , bj.exec_start_time ${model.execStartSort}
            </if>
            <if test="model.execEndSort != null and model.execEndSort != ''">
                , bj.exec_end_time ${model.execEndSort}
            </if>
            <if test="model.cycSort != null and model.cycSort != ''">
                , bj.cyc_time ${model.cycSort}
            </if>
            <if test="model.businessDateSort != null and model.businessDateSort != ''">
                , bj.business_date ${model.businessDateSort}
            </if>
            <if test="model.retryNumSort != null and model.retryNumSort != ''">
                , bj.retry_num ${model.retryNumSort}
            </if>
            <if test="orderBy != null and orderBy != ''">
                , bj.${orderBy} ${sort}
            </if>
            , bj.gmt_create desc
        </trim>
        <if test="start != null and pageSize != null">
            limit #{start} , #{pageSize}
        </if>
        <if test="start == null and pageSize != null">
            limit #{pageSize}
        </if>
        <if test="start == null and pageSize == null">
            limit 1000
        </if>
    </sql>

    <sql id="update_fragment">
        <set>
            <if test="tenantId != null and tenantId > 0">
                tenant_id = #{tenantId},
            </if>
            <if test="projectId != null and projectId > 0">
                project_id = #{projectId},
            </if>
            <if test="jobId != null">
                job_id = #{jobId},
            </if>
            <if test="jobKey != null">
                job_key = #{jobKey},
            </if>
            <if test="jobName != null">
                job_name = #{jobName},
            </if>
            <if test="taskId != null">
                task_id = #{taskId},
            </if>
            <if test="gmtCreate != null">
                gmt_create = #{gmtCreate},
            </if>
            <if test="gmtModified != null">
                gmt_modified = #{gmtModified},
            </if>
            <if test="createUserId != null">
                create_user_id = #{createUserId},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted},
            </if>
            <if test="type != null">
                type = #{type},
            </if>
            <if test="isRestart != null">
                is_restart = #{isRestart},
            </if>
            <if test="businessDate != null">
                business_date = #{businessDate},
            </if>
            <if test="cycTime != null">
                cyc_time = #{cycTime},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="dtuicTenantId !=null and dtuicTenantId > 0">
                dtuic_tenant_id = #{dtuicTenantId},
            </if>
            <if test="appType!=null">
                app_type = #{appType},
            </if>
            <if test="retryNum != null">
                retry_num = #{retryNum},
            </if>
            <if test="maxRetryNum != null">
                max_retry_num = #{maxRetryNum},
            </if>
            <if test="retryType != null">
                retry_type = #{retryType},
            </if>
            <if test="phaseStatus != null">
                phase_status = #{phaseStatus},
            </if>
            <if test="versionId != null">
                version_id = #{versionId},
            </if>
            <if test="submitUserName != null">
                submit_user_name = #{submitUserName},
            </if>
            <if test="businessType != null">
                business_type = #{businessType},
            </if>
            <if test="nextCycTime != null">
                next_cyc_time = #{nextCycTime},
            </if>
            <if test="jobBuildType != null">
                job_build_type = #{jobBuildType},
            </if>
        </set>
    </sql>

    <select id="getOne" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="listByJobIds" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE id in
        <foreach item="id" index="index" collection="jobIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="getJobRangeByCycTimeByLimit" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        from schedule_job bj
        where task_id = #{taskId}
        AND app_type = #{appType} AND type = #{type}
        <if test="fillId!=null and fillId != -1">
            AND fill_id = #{fillId}
        </if>
        <choose>
            <when test="isAfter">
                AND cyc_time >= #{cycTime}
                 ORDER BY cyc_time ASC
            </when>
            <otherwise>
                <![CDATA[ AND cyc_time < ]]> #{cycTime}
                 ORDER BY cyc_time DESC
            </otherwise>
        </choose>
        LIMIT #{limit}
    </select>

    <select id="getNewestTempJob" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        from schedule_job bj
        where task_id = #{taskId}
        AND app_type = #{appType} AND type = #{type}
        AND status = #{status}
        order by id desc limit 1;
    </select>

    <select id="getByJobKeyAndType" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE job_key = #{jobKey} AND type = #{type} AND is_deleted = 0
    </select>

    <select id="getByJobKey" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE job_key = #{jobKey} AND is_deleted = 0
    </select>


    <select id="countByStatusAndType" resultType="java.util.HashMap">
        SELECT status,COUNT(1) as count
        FROM schedule_job ts
        WHERE ts.is_deleted = 0
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND ts.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1">
            AND ts.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND ts.tenant_id = #{tenantId}
        </if>
        AND ts.type = #{type}
        AND ts.app_type = #{appType}
        AND ts.flow_job_id = '0'
        <if test="startTime != null and startTime != ''">
            AND ts.cyc_time <![CDATA[>=]]> #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND ts.cyc_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="statuses != null ">
            AND ts.status in
            <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        group by status
    </select>

    <select id="countByStatusAndTypeProjectIds" resultType="com.dtstack.engine.dto.ScheduleJobCount">
        SELECT project_id,status,COUNT(1) as count
        FROM schedule_job ts
        WHERE ts.is_deleted = 0
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND ts.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectIds !=null">
            AND ts.project_id IN
            <foreach item="projectId" collection="projectIds" open="(" separator="," close=")">
                #{projectId}
            </foreach>

        </if>
        <if test="tenantId!=null">
            AND ts.tenant_id = #{tenantId}
        </if>
        AND ts.type = #{type}
        AND ts.app_type = #{appType}
        AND ts.task_type != 10
        <if test="startTime != null and startTime != ''">
            AND ts.cyc_time <![CDATA[>=]]> #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND ts.cyc_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="statuses != null ">
            AND ts.status in
            <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        group by project_id, status
    </select>

    <select id="selectStatusAndType" resultType="java.util.HashMap">
        SELECT if(ts.is_deleted = 1,CONCAT(ts.name,'(已删除)'),ts.name) AS name, bj.status AS status,bj.exec_start_time AS
        execStartTime
        FROM schedule_job bj
        LEFT JOIN schedule_task_shade ts on bj.task_id = ts.task_id
        WHERE bj.is_deleted = 0
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1">
            AND bj.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND bj.tenant_id = #{tenantId}
        </if>
        AND bj.type = #{type}
        AND bj.app_type = #{appType}
        AND ts.app_type = #{appType}
        AND bj.task_type != 10
        <if test="startTime != null and startTime != ''">
            AND bj.cyc_time <![CDATA[>=]]> #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND bj.cyc_time <![CDATA[<]]> #{endTime}
        </if>
        <if test="statuses != null ">
            AND bj.status in
            <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        ORDER BY bj.exec_start_time LIMIT #{startPage}, #{pageSize}
    </select>


    <select id="listTopRunTime" resultType="java.util.HashMap">
        SELECT bj.id AS id, bj.task_id AS taskId, bj.cyc_time AS cycTime, ifnull(bj.type, 0) AS type,bj.task_type as
        taskType,
        bj.exec_time AS execTime,bj.is_deleted as isDeleted,bj.create_user_id AS createUserId
        FROM schedule_job bj
        WHERE bj.is_deleted = 0
        AND bj.app_type = #{appType}
        AND bj.flow_job_id = '0'
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1">
            AND bj.project_id = #{projectId}
        </if>
        AND bj.exec_start_time &gt;= #{startTime} AND bj.exec_start_time &lt;= #{endTime}
        ORDER BY bj.exec_time desc limit #{pageQuery.start}, #{pageQuery.pageSize}
    </select>

    <select id="listTopSizeRunTimeJob" resultType="java.util.HashMap">
        SELECT bj.id AS id, bj.task_id AS taskId, bj.cyc_time AS cycTime, ifnull(bj.type, 0) AS type,bj.task_type as
        taskType,
        bj.exec_time AS execTime,bj.is_deleted as isDeleted,bj.create_user_id AS createUserId,
        ts.name as taskName, ts.owner_user_id as ownerUserId
        FROM schedule_job bj
         LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
          WHERE bj.is_deleted = 0
        AND bj.app_type = #{model.appType} AND ts.app_type = #{model.appType}
        <if test="model.dtuicTenantId != null and model.dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{model.dtuicTenantId}
        </if>
        <if test="model.projectId != null and model.projectId != -1">
            AND bj.project_id = #{model.projectId}
        </if>
        AND bj.exec_start_time &gt;= #{model.execStartDay} AND bj.exec_start_time &lt;= #{model.execEndDay}
        <if test="model.type != null">
            AND bj.type = #{model.type}
        </if>
        ORDER BY bj.exec_time desc limit #{model.pageSize}
    </select>

    <select id="listTopErrorByType" resultType="com.dtstack.engine.api.vo.JobTopErrorVO">
        SELECT bj.task_id AS taskId, count(1) as errorCount
        FROM schedule_job bj
        WHERE bj.is_deleted = 0
        AND bj.flow_job_id = '0'
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1">
            AND bj.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND bj.tenant_id = #{tenantId}
        </if>
        AND bj.app_type = #{appType}
        AND bj.status in
        <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND bj.type = #{type}
        AND bj.id >= (select min(id) from schedule_job where cyc_time >= #{cycTime})
        group by bj.task_id
        ORDER BY count(1) desc limit #{pageQuery.start}, #{pageQuery.pageSize}
    </select>

    <select id="listTopError" resultType="com.dtstack.engine.api.vo.JobTopErrorVO">
        SELECT bj.task_id AS taskId, count(1) as errorCount
        FROM schedule_job bj
        WHERE bj.is_deleted = 0
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1">
            AND bj.project_id = #{projectId}
        </if>
        AND bj.app_type = #{appType}
        AND bj.status in
        <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND bj.type = #{type}
        AND bj.cyc_time >= #{startCycTime}
        AND bj.cyc_time &lt;= #{endCycTime}
        group by bj.task_id
        ORDER BY count(1) desc limit #{pageQuery.start}, #{pageQuery.pageSize}
    </select>

    <select id="listThirtyDayJobs" resultType="java.util.HashMap">
        SELECT DATE_FORMAT(bj.cyc_time, '%m/%d') AS day, COUNT(1) AS cnt
        FROM schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        WHERE bj.cyc_time is not null and to_days(bj.cyc_time) >= (to_days(NOW()) -30)
        and bj.type = #{type}
        and bj.project_id = #{projectId}
        and bj.tenant_id = #{tenantId}
        and bj.is_deleted = 0
        and bj.app_type = ts.app_type
        <if test="taskTypes != null and taskTypes.size()>0">
            and ts.task_type in
            <foreach collection="taskTypes" item="taskType" open="(" close=")" separator=",">
                #{taskType}
            </foreach>
        </if>
        <if test="statusList != null and statusList.size()>0">
            and bj.status in
            <foreach collection="statusList" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        GROUP BY day
    </select>

    <select id="countScienceJobStatus" resultType="java.util.HashMap">
        SELECT COUNT(1) AS total,
        SUM(case when bj.status = 4 or bj.status = 16 then 1 else 0 end) AS deployCount,
        SUM(case when bj.status = 8 then 1 else 0 end) AS failCount,
        SUM(case when bj.status = #{status} then 1 else 0 end) AS successCount
        FROM schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        WHERE bj.type = #{type}
        and bj.tenant_id = #{tenantId}
        and bj.is_deleted = 0
        and bj.flow_job_id = 0
        and bj.app_type = ts.app_type
        <if test="taskTypes != null and taskTypes.size()>0">
            and ts.task_type in
                <foreach collection="taskTypes" item="taskType" open="(" close=")" separator=",">
                    #{taskType}
                </foreach>
        </if>
        <if test="cycStartDay != null and cycEndDay != null">
            AND bj.cyc_time &gt;= ${cycStartDay} and bj.cyc_time &lt;= ${cycEndDay}
        </if>
        <if test="projectIds != null and projectIds.size()>0">
            and bj.project_id in
            <foreach collection="projectIds" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="generalScienceCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        from (
        select <include refid="select_filed_all"/>,'' as groupDate from schedule_job
        <include refid="select_where_batch_job"/>
        and period_type not in (0,1)

        union
        select <include refid="select_filed_all"/> ,left(business_date,8) as groupDate from schedule_job
        <include refid="select_where_batch_job"/>
        and period_type in (0,1)
        group by task_id,groupDate
        )bj
        <include refid="select_where_batch_job"/>
        <if test="model.taskIds != null and model.taskIds.size > 0">
            or bj.task_id in
            <foreach collection="model.taskIds" item="taskId" open="(" separator="," close=")">
                #{taskId}
            </foreach>
        </if>
        limit 1
    </select>



    <select id="listTodayJobs" resultType="java.util.HashMap">
        SELECT DATE_FORMAT(bj.exec_start_time, '%H') AS hour, COUNT(1) AS data
        FROM schedule_job bj
        WHERE bj.exec_start_time is not null and bj.exec_start_time >= #{today}
        AND bj.type = #{type}
        AND bj.is_deleted = 0
        AND bj.flow_job_id = '0'
        <if test="appType != null and appType != -1">
            AND bj.app_type = #{appType}
        </if>
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1 ">
            AND bj.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND bj.tenant_id = #{tenantId}
        </if>
        <if test="statusList != null and statusList.size()>0">
            AND bj.status IN
            <foreach collection="statusList" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        GROUP BY hour
    </select>

    <select id="listTodayJobGraph" resultType="com.dtstack.engine.po.TodayJobGraph">
        SELECT DATE_FORMAT(bj.exec_start_time, '%H') AS hour, COUNT(1) AS count
        FROM schedule_job bj
        WHERE bj.exec_start_time is not null and bj.exec_start_time >= #{today}
        AND bj.type = #{type}
        AND bj.is_deleted = 0
        <if test="appType != null and appType != -1">
            AND bj.app_type = #{appType}
        </if>
        <if test="projectId!=null and projectId != -1 ">
            AND bj.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND bj.tenant_id = #{tenantId}
        </if>
        <if test="statusList != null and statusList.size()>0">
            AND bj.status IN
            <foreach collection="statusList" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        GROUP BY hour
    </select>



    <select id="generalScienceQuery" parameterType="com.dtstack.engine.api.pager.PageQuery" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        from (
        select
        <include refid="select_filed_all_bj"/>,'' as groupDate from schedule_job
        <include refid="select_where_batch_job"/>
        and period_type not in (0,1)
        union
        select
        <include refid="select_content_fragment"/>,
        left(bj.business_date,8) as groupDate
        from schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.period_type in (0,1)
        group by bj.task_id,groupDate
        )bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.app_type = ts.app_type
        <if test="model.pageQuery == true">
            <include refid="page_condition"/>
        </if>

    </select>

    <select id="listYesterdayJobs" resultType="java.util.HashMap">
        SELECT DATE_FORMAT(bj.exec_start_time, '%H') AS hour, COUNT(1) AS data
        FROM schedule_job bj
        WHERE bj.exec_start_time is not null and bj.exec_start_time >= #{yesterday}
        and bj.exec_start_time &lt; #{today}
        and bj.type = #{type}
        and bj.flow_job_id = '0'
        <if test="appType != null and appType != -1">
            AND bj.app_type = #{appType}
        </if>
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1">
            AND bj.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND bj.tenant_id = #{tenantId}
        </if>
        and bj.is_deleted = 0
        <if test="statusList != null and statusList.size()>0">
            and bj.status in
            <foreach collection="statusList" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        GROUP BY hour
    </select>

    <select id="listMonthJobs" resultType="java.util.HashMap">
        SELECT DATE_FORMAT(bj.exec_start_time, '%H') AS hour, COUNT(1) AS data
        FROM schedule_job bj
        WHERE bj.exec_start_time is not null and bj.exec_start_time >= #{lastMonth}
        and bj.type = #{type}
        and bj.flow_job_id = '0'
        <if test="appType != null and appType != -1">
            AND bj.app_type = #{appType}
        </if>
        <if test="dtuicTenantId != null and dtuicTenantId != -1">
            AND bj.dtuic_tenant_id = #{dtuicTenantId}
        </if>
        <if test="projectId!=null and projectId != -1 ">
            AND bj.project_id = #{projectId}
        </if>
        <if test="tenantId!=null">
            AND bj.tenant_id = #{tenantId}
        </if>
        and bj.is_deleted = 0
        <if test="statusList != null and statusList.size()>0">
            and bj.status in
            <foreach collection="statusList" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        GROUP BY hour
    </select>

    <select id="listJobByJobKeys" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where job_key IN
        <foreach item="jobKey" index="index" collection="jobKeys" open="(" separator="," close=")">
            #{jobKey}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="listSimpleJobByJobKeys" resultType="com.dtstack.engine.dto.SimpleJob">
        SELECT
        id,job_id, job_key, cyc_time, status, task_type, task_id
        FROM schedule_job bj
        where job_key IN
        <foreach item="jobKey" index="index" collection="jobKeys" open="(" separator="," close=")">
            #{jobKey}
        </foreach>
        AND is_deleted = 0
    </select>

    <select id="listRuleJobByJobKeys" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where job_key IN
        <foreach item="jobKey" index="index" collection="jobKeys" open="(" separator="," close=")">
            #{jobKey}
        </foreach>
        AND is_deleted = 0 AND task_rule = #{ruleCode}
    </select>

    <select id="listIdByTaskIdAndStatus" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where bj.task_id = #{taskId}
        AND bj.status IN
        <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND bj.is_deleted = 0
        AND bj.app_type = #{appType}
        <if test="cycTime!=null">
            AND bj.cyc_time >= #{cycTime}
        </if>
        <if test="type!=null">
            AND bj.type = #{type}
        </if>
    </select>


    <select id="listIdByTaskIdAndStatusBeforeCyctime" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where bj.task_id = #{taskId}
        AND bj.status IN
        <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND bj.is_deleted = 0
        AND bj.app_type = #{appType}
        <if test="cycTime!=null">
            AND bj.cyc_time <![CDATA[ < ]]> #{cycTime}
        </if>
        <if test="type!=null">
            AND bj.type = #{type}
        </if>
        ORDER BY cyc_time DESC
    </select>

    <select id="listJobIdByTaskIdAndStatus" resultType="java.lang.String">
        SELECT
        bj.job_id
        FROM schedule_job bj
        where  bj.task_id = #{taskId}
        AND bj.app_type =#{appType}
        AND bj.status IN
        <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND bj.is_deleted = 0
    </select>

    <select id="listTaskExeTimeInfo" resultType="java.util.HashMap">
        select bj.job_id AS jobId, bj.exec_start_time AS execStartTime, bj.exec_end_time AS execEndTime, bj.exec_time
        AS execTime
        from schedule_job bj
        where bj.task_id = #{taskId}
        AND bj.status IN
        <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
            #{status}
        </foreach>
        AND bj.is_deleted = 0 AND bj.is_deleted = 0
        AND bj.app_type = #{appType}
        order by ${pageQuery.orderBy} ${pageQuery.sort} limit #{pageQuery.start} , #{pageQuery.pageSize}
    </select>

    <select id="getByJobIds" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        <if test="isDeleted!=null">
            and is_deleted = #{isDeleted}
        </if>
    </select>

    <select id="getByJobId" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where job_id = #{jobId}
        <if test="isDeleted!=null">
            and is_deleted = #{isDeleted}
        </if>
        limit 1
    </select>

    <select id="getId" resultType="java.lang.Long">
        SELECT
        id
        FROM schedule_job bj
        where job_id = #{jobId} AND is_deleted = 0
    </select>

    <sql id="groupColumn">
         id,tenant_id,project_id,job_id,job_key,job_name,task_id,gmt_create,max(gmt_modified) as gmt_modified,create_user_id,is_deleted,type,is_restart,business_date,cyc_time,dependency_type,flow_job_id
      ,period_type ,left(business_date,8) as groupDate
    </sql>

    <select id="generalQuery" parameterType="com.dtstack.engine.api.pager.PageQuery" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        <include refid="select_where_fragment"/>
        <include refid="queryWorkFlow"/>
        <if test="model.jobIds != null and model.jobIds.size > 0">
            or bj.job_id in
            <foreach collection="model.jobIds" item="jobId" open="(" separator="," close=")">
                #{jobId}
            </foreach>
        </if>
        <if test="model.pageQuery == true">
            <include refid="page_condition"/>
        </if>

    </select>

    <select id="minOrHourJobQuery" parameterType="com.dtstack.engine.api.pager.PageQuery" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        from  schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.app_type = ts.app_type
        <include refid="queryWorkFlow"/>
        <if test="model.jobIds != null and model.jobIds.size > 0">
            or bj.job_id in
            <foreach collection="model.jobIds" item="jobId" open="(" separator="," close=")">
                #{jobId}
            </foreach>
        </if>
        <if test="model.ownerUserId != null">
            AND ts.owner_user_id = #{model.ownerUserId}
        </if>
        <if test="model.pageQuery == true">
            <include refid="page_condition"/>
        </if>
    </select>

    <select id="generalCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM schedule_job bj
        <include refid="select_where_fragment"/>
        <include refid="queryWorkFlow"/>
        <if test="model.jobIds != null and model.jobIds.size > 0">
            or bj.job_id in
            <foreach collection="model.jobIds" item="jobId" open="(" separator="," close=")">
                #{jobId}
            </foreach>
        </if>
        limit 1
    </select>

    <select id="generalQueryWithMinAndHour" parameterType="com.dtstack.engine.api.pager.PageQuery" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        from (
        select
        <include refid="select_filed_all_bj"/>
        ,'' as groupDate from schedule_job
        <include refid="select_where_batch_job"/>
        union
        select
        <include refid="select_content_fragment"/>,
        left(bj.business_date,8) as groupDate
        from schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.app_type = ts.app_type
        group by bj.task_id,groupDate
        )bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.app_type = ts.app_type
        <if test="model.pageQuery == true">
            <include refid="page_condition"/>
        </if>
    </select>

    <select id="generalCountWithMinAndHour" resultType="java.lang.Integer">
        SELECT COUNT(1)
        from (
        select <include refid="select_filed_all"/> ,'' as groupDate from schedule_job
        <include refid="select_where_batch_job"/>

        union
        select <include refid="select_filed_all"/> ,left(business_date,8) as groupDate from schedule_job
        <include refid="select_where_batch_job"/>
        group by task_id,groupDate
        )bj
        <include refid="select_where_batch_job"/>
        <if test="model.taskIds != null and model.taskIds.size > 0">
            or bj.task_id in
            <foreach collection="model.taskIds" item="taskId" open="(" separator="," close=")">
                #{taskId}
            </foreach>
        </if>
        limit 1
    </select>

    <select id="syncQueryJob" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
         FROM schedule_job bj
        <include refid="select_where_batch_job"/>
           AND is_deleted = 0
        ORDER BY id DESC
        <if test="start != null and pageSize != null">
            limit #{start} , #{pageSize}
        </if>
    </select>

    <select id="minOrHourJobCount" resultType="java.lang.Integer">
        select count(1)
        FROM schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        <include refid="queryWorkFlow"/>
        <if test="model.jobIds != null and model.jobIds.size > 0">
            or bj.job_id in
            <foreach collection="model.jobIds" item="jobId" open="(" separator="," close=")">
                #{jobId}
            </foreach>
        </if>
        <if test="model.ownerUserId != null">
            AND ts.owner_user_id = #{model.ownerUserId}
        </if>
    </select>

    <select id="getJobsStatusStatistics" resultType="StatusCount">
        SELECT status, COUNT(1) as count
        FROM schedule_job bj
        <include refid="select_where_batch_job"/>
        group by status
    </select>

    <sql id="queryWorkFlow">
        <if test="model.queryWorkFlowModel == 1">
            AND bj.flow_job_id = "0"
        </if>
        <if test="model.queryWorkFlowModel == 2">
            AND bj.flow_job_id != "0"
        </if>
        <if test="model.queryWorkFlowModel == 4">
            AND bj.task_type != 10
        </if>
    </sql>

    <insert id="batchInsert" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO schedule_job
        (tenant_id,project_id,dtuic_tenant_id,app_type,job_id,job_key,job_name,task_id,gmt_create,gmt_modified,create_user_id,is_deleted,type,is_restart,business_date,cyc_time,dependency_type,flow_job_id,period_type,next_cyc_time,task_type,node_address,max_retry_num,retry_type,version_id,fill_id,task_rule,business_type,compute_type,job_execute_order,fill_type,resource_id,calender_id,job_build_type)
        VALUES
        <foreach item="item" index="index" collection="list" separator=",">
            (#{item.tenantId},#{item.projectId},#{item.dtuicTenantId},#{item.appType},#{item.jobId},#{item.jobKey},#{item.jobName},#{item.taskId},#{item.gmtCreate},#{item.gmtModified},#{item.createUserId},#{item.isDeleted},#{item.type},
            #{item.isRestart},#{item.businessDate},#{item.cycTime},#{item.dependencyType},#{item.flowJobId},#{item.periodType},#{item.nextCycTime},#{item.taskType},#{item.nodeAddress},#{item.maxRetryNum},#{item.retryType},#{item.versionId},#{item.fillId},#{item.taskRule},#{item.businessType},#{item.computeType},#{item.jobExecuteOrder},#{item.fillType},#{item.resourceId},#{item.calenderId},#{item.jobBuildType})
        </foreach>
    </insert>

    <update id="update" parameterType="ScheduleJob">
        UPDATE
        schedule_job
        <include refid="update_fragment"/>
        WHERE job_id = #{jobId} AND is_deleted = 0
    </update>

    <update id="updateToDeleted">
        UPDATE
        schedule_job SET is_deleted = 1
        WHERE is_deleted = 0 AND app_type = #{appType} AND job_id IN
        <foreach collection="jobIds" item="jobId" index="index" open="(" separator="," close=")">
            #{jobId}
        </foreach>
    </update>

    <select id="selectDeletedJobIds" resultType="java.lang.String">
        SELECT job_id FROM schedule_job WHERE is_deleted = 1 AND app_type = #{appType}
    </select>


    <update id="updateStatusWithExecTime" parameterType="ScheduleJob">
        UPDATE
        schedule_job
        SET
        <if test="execStartTime != null">
            exec_start_time = #{execStartTime},
        </if>
        <if test="execEndTime != null">
            exec_end_time = #{execEndTime},
        </if>
        <if test="execTime != null">
            exec_time = #{execTime},
        </if>
        status = #{status},gmt_modified=now()
        WHERE job_id = #{jobId} AND is_deleted = 0 AND app_type = #{appType}
    </update>

    <select id="listFillJobName" resultType="java.lang.String">
        SELECT DISTINCT substring_index(bj.job_name, '-', 1)
        FROM schedule_job bj
        <include refid="select_where_fragment_without_ts"/>
        <include refid="page_condition"/>
    </select>

    <select id="countFillJobNameDistinct" resultType="java.lang.Integer">
        SELECT count(DISTINCT bj.fill_id) FROM
        schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
    </select>


    <select id="countFillJobNameDistinctWithOutTask" resultType="java.lang.Integer">
        SELECT count(DISTINCT bj.fill_id) FROM
        schedule_job bj
        <include refid="select_where_batch_job"/>
    </select>

    <select id="countFillJobName" resultType="java.lang.Integer">
        SELECT count(job_name)
        FROM schedule_job bj
        <include refid="select_where_fragment_without_ts"/>
    </select>

    <select id="listNeedStopFillDataJob" resultType = "ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE bj.job_name like #{fillDataJobName} AND bj.status IN
        <foreach item="status" index="index" collection="statusList" open="(" separator="," close=")">
            #{status}
        </foreach>
        <if test="projectId !=null">
            and bj.project_id = #{projectId}
        </if>
        <if test="appType!=null">
            and bj.app_type = #{appType}
        </if>
        and bj.is_deleted = 0
        AND bj.id > #{startId}
        ORDER BY bj.id ASC
        LIMIT #{limit}
    </select>

    <select id="listFillJobBizDate" resultType="java.lang.String">
        SELECT DISTINCT SUBSTR(business_date FROM 1 FOR 8)
        FROM schedule_job bj
        <include refid="select_where_fragment_without_ts"/>
    </select>

    <select id="listTaskExeInfo" resultType="java.util.HashMap">
        select a.exec_start_time as execStartTime, a.exec_end_time as execEndTime,  a.job_id as jobId, ifnull(a.type, 0) as type,
               ifnull(a.status, 0) as status, a.exec_time as execTime from schedule_job a
        where a.task_id = #{taskId} and a.project_id = #{projectId} and a.app_type = #{appType}
        and a.type in
        <foreach collection="types" index="index" item="type" open="(" close=")" separator=",">
            #{type}
        </foreach>
        order by a.exec_start_time desc limit #{limitNum};
    </select>

    <select id="getSubJobsAndStatusByFlowId" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE flow_job_id = #{jobId} AND is_deleted = 0 AND flow_job_id != '0'
    </select>

    <select id="countFillDataAllStatusByJobName" resultType="java.util.HashMap">
        SELECT
        bj.status*1 as status,count(bj.status) as count
        FROM
        schedule_job bj
        WHERE
        bj.is_deleted = 0
        AND bj.job_name LIKE '${jobName}%'
        <if test="jobIds != null and jobIds.size > 0">
            AND bj.job_id NOT IN
            <foreach collection="jobIds" item="jobId" index="index" open="(" separator="," close=")">
                #{jobId}
            </foreach>
        </if>
        AND bj.type = 1
        GROUP BY bj.status
    </select>

    <select id="getWorkFlowSubJobId" resultType="ScheduleJob">
        SELECT <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE flow_job_id in
        <foreach item="id" index="index" collection="jobIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND flow_job_id != '0'
        AND is_deleted = 0
    </select>

    <select id="getSubJobsByFlowIds" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE flow_job_id in
        <foreach item="flowId" index="index" collection="flowIds" open="(" separator="," close=")">
            #{flowId}
        </foreach>
        AND bj.is_deleted = 0
    </select>

    <select id="countByFillDataAllStatus" resultType="java.util.HashMap">
        SELECT
        bj.status*1 as status,
        count(bj.status) as count,
        bj.fill_id as fillId
        FROM
        schedule_job bj
        where
        bj.is_deleted = 0
        AND bj.flow_job_id = 0
        AND bj.type = #{type}
        AND bj.fill_type IN (0,1)
        AND bj.fill_id in
        <foreach collection="fillIdList" index="index" item="fillId" open="(" close=")" separator=",">
            #{fillId}
        </foreach>
        <if test="appType!=null">
            AND bj.app_type = #{appType}
        </if>
        group by bj.fill_id,bj.status
    </select>

    <select id="listFillIdList" resultType="java.lang.String">
        SELECT DISTINCT
        bj.fill_id
        FROM schedule_job bj
        <include refid="select_where_fragment"/>
        <include refid="page_condition"/>
    </select>


    <select id="listFillIdListWithOutTask" resultType="java.lang.String">
        SELECT DISTINCT
        bj.fill_id
        FROM schedule_job bj
        <include refid="select_where_batch_job"/>
        and fill_id is NOT null
        <include refid="page_condition"/>
    </select>

    <select id="queryFillData" resultType="ScheduleJob">
        select
        <include refid="select_content_fragment"/>
        from
        schedule_job bj
        left join schedule_task_shade ts on bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.fill_id = #{model.fillId}
        <include refid="queryWorkFlow"/>
        <if test="model.ownerUserId != null">
            AND ts.owner_user_id = #{model.ownerUserId}
        </if>
        <if test="model.appType != null">
            and bj.app_type =#{model.appType} and ts.app_type = #{model.appType}
        </if>
        <include refid="page_condition"/>
    </select>

    <select id="countByFillData" resultType="java.lang.Integer">
        select count(bj.id)
        from schedule_job bj
        left join schedule_task_shade ts on bj.task_id = ts.task_id
        <include refid="select_where_fragment"/>
        and bj.fill_id  = #{model.fillId}
        <include refid="queryWorkFlow"/>
        <if test="model.ownerUserId != null">
            AND ts.owner_user_id = #{model.ownerUserId}
        </if>
        <if test="model.appType != null">
            and bj.app_type =#{model.appType} and ts.app_type = #{model.appType}
        </if>
    </select>

    <select id="getWorkFlowTopNode" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM
        schedule_job bj
        WHERE
        bj.job_key IN ( SELECT job_key FROM schedule_job_job WHERE parent_job_key = ( SELECT job_key FROM schedule_job
        WHERE job_id = #{jobId} ) )
        AND bj.flow_job_id != '0'
    </select>

    <select id="listByJobIdList" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        where job_id in
        <foreach collection="jobIds" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        <if test="projectId != null"> and project_id = #{projectId} </if>
    </select>

    <select id="listJobIdByTaskType" resultType="java.lang.String">
        SELECT
        job_id
        from schedule_job
        where task_type = #{taskType} and is_deleted = 0
    </select>

    <select id="getStatusByJobId" resultType="java.lang.Integer">
        SELECT
            status
        FROM schedule_job
        WHERE job_id = #{jobId} AND is_deleted = 0
    </select>

    <select id="getJobExecStartTime" resultType="java.sql.Timestamp">
        SELECT
            exec_start_time
        FROM schedule_job
        WHERE job_id = #{jobId} AND is_deleted = 0
    </select>

    <select id="countTasksByCycTimeTypeAndAddress" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM schedule_job
        WHERE node_address = #{nodeAddress}
        AND type = #{scheduleType}
        AND task_type != 10
        <if test="cycStartTime != null">
            AND cyc_time &gt;= #{cycStartTime}
        </if>
        <if test="cycEndTime != null">
            AND cyc_time &lt; #{cycEndTime}
        </if>
        AND (status = 0 or (status = 10 and task_type in (10, 14)))
        AND is_deleted = 0
    </select>

    <select id="listSimpleJobByStatusAddress" resultType="SimpleScheduleJobPO">
        SELECT id, job_id, type, phase_status
        FROM schedule_job
        WHERE id > #{startId} AND (node_address = #{nodeAddress} or node_address is null)
        <if test="statuses != null">
            AND status IN
            <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        AND is_deleted = 0
        order by id asc limit 500
    </select>

    <update id="updateNodeAddress">
        UPDATE
        schedule_job
        set node_address = #{nodeAddress}
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
    </update>


    <update id="updateJobStatusByIds">
        UPDATE schedule_job
        SET status = #{status},gmt_modified = now()
        WHERE is_deleted=0
        AND job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted=0;
    </update>

    <update id="stopUnsubmitJob">
        UPDATE  schedule_job
        set status = #{status} where status = 0
        and job_name like #{likeName}
        <if test="projectId!=null">
            and project_id = #{projectId}
        </if>
        <if test="appType !=null">
            and app_type = #{appType}
        </if>
    </update>

    <select id="getByTaskIdAndStatusOrderByIdLimit" resultType="ScheduleJob">
        SELECT
        <include refid="select_filed_all"/>
        FROM schedule_job job
        WHERE job.task_id = #{taskId} and  #{time} > STR_TO_DATE(job.cyc_time,"%Y%m%d%H%i%s")
          and job.status = #{status}
          and job.is_deleted = 0
          and job.app_type = #{appType}
        <if test="type !=null">
            and job.type = #{type}
        </if>
        order by job.cyc_time desc limit 1
    </select>

    <select id="listExecJobByCycTimeTypeAddress" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        ,bj.job_execute_order
        FROM schedule_job bj
        WHERE
        node_address = #{nodeAddress}
        <if test="isEq">
            AND job_execute_order >= #{startId}
        </if>
        <if test="!isEq">
            AND job_execute_order > #{startId}
        </if>
        <if test="scheduleType != null">
            AND type = #{scheduleType}
        </if>
        <if test="cycStartTime != null">
            AND cyc_time &gt;= #{cycStartTime}
        </if>
        <if test="cycEndTime != null">
            AND cyc_time &lt; #{cycEndTime}
        </if>
        <if test="lastTime != null">
            AND gmt_modified &gt;= #{lastTime}
        </if>
        <if test="isRestart != null">
            AND is_restart = #{isRestart}
        </if>
        AND (status = 0 or ((status = 10 or status=4) and task_type in (10, 14,27,41)))
        AND is_deleted = 0
        AND `phase_status` = #{phaseStatus}
        order by job_execute_order asc limit #{limit}
    </select>

    <select id="listExecJobByJobIds" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE
        is_deleted = 0
        <if test="nodeAddress != null">
            AND node_address = #{nodeAddress}
        </if>
        <if test="isRestart != null">
            AND is_restart = #{isRestart}
        </if>
        AND (status = 0 or ((status = 10 or status=4) and task_type in (10, 14,27,41)))
        AND `phase_status` = #{phaseStatus}
        <if test="jobIds != null and jobIds.size > 0">
            AND bj.job_id IN
            <foreach collection="jobIds" item="jobId" index="index" open="(" separator="," close=")">
                #{jobId}
            </foreach>
        </if>
    </select>

    <update id="updateJobInfoByJobId">
        UPDATE schedule_job
        <set>
            <if test="status!=null">
                status = #{status},
            </if>
            <if test="execStartTime != null">
                exec_start_time = #{execStartTime},
            </if>
            <if test="execEndTime != null">
                exec_end_time = #{execEndTime},
                exec_time = timestampdiff(SECOND, exec_start_time, now()),
            </if>
            <if test="retryNum!=null">
                retry_num = #{retryNum},
            </if>
            gmt_modified = now()
        </set>
        WHERE job_id = #{jobId}
        <if test="stopStatuses!=null and stopStatuses.size() > 0">
            AND status NOT IN
            <foreach item="stopStatus" index="index" collection="stopStatuses" open="(" separator="," close=")">
                #{stopStatus}
            </foreach>
        </if>
        AND is_deleted=0
    </update>


    <update id="updateStatusByJobId">
        UPDATE schedule_job
        <set>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="versionId != null">
                version_id = #{versionId},
            </if>
            <if test="execStartTime != null">
                exec_start_time = #{execStartTime},
            </if>
            <if test="execEndTime != null">
                exec_end_time = #{execEndTime},
            </if>
            gmt_modified = now()
        </set>
        WHERE job_id = #{jobId}
        AND is_deleted=0
    </update>

    <update id="updateResourceIdByJobId">
        UPDATE schedule_job
        <set>
            resource_id = #{resourceId},
            gmt_modified = now()
        </set>
        WHERE job_id = #{jobId}
        AND is_deleted=0
    </update>

    <update id="updateNullTime">
        update
            schedule_job
        set
            exec_start_time = null ,
            exec_end_time = null
        WHERE job_id = #{jobId}
          AND is_deleted=0
    </update>

    <select id="listByBusinessDateAndPeriodTypeAndStatusList" resultType="ScheduleJob">
        select
        <include refid="select_content_fragment"/>
        from schedule_job bj
        LEFT JOIN schedule_task_shade ts on ts.task_id = bj.task_id
        WHERE
        ts.flow_id = 0
        <if test="model.taskPeriodId != null and model.taskPeriodId.size()>0">
            AND bj.period_type IN
            <foreach collection="model.taskPeriodId" separator="," index="index" item="item" open="(" close=")">
                ${item}
            </foreach>
        </if>
        <if test="model.jobStatuses != null and model.jobStatuses.size() > 0">
            AND bj.status IN
            <foreach item="status" index="index" collection="model.jobStatuses" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        <if test="model.bizStartDay != null and model.bizEndDay != null">
            AND bj.business_date &gt;= ${model.bizStartDay} and bj.business_date &lt; ${model.bizEndDay}
        </if>
        AND bj.tenant_id = ${model.tenantId} AND bj.project_id = ${model.projectId} AND bj.is_deleted = 0
        AND bj.type = 0
    </select>

    <select id="listJobByCyctimeAndJobName" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE cyc_time like '${preCycTime}%'
        AND job_name LIKE '${preJobName}%'
        AND is_deleted = 0
        <if test="scheduleType != null">
            AND type = #{scheduleType}
        </if>
    </select>

    <select id="listJobByCyctimeAndJobNameBatch" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE id > #{startId}
        AND cyc_time LIKE '${preCycTime}%'
        AND job_name LIKE '${preJobName}%'
        AND is_deleted = 0
        <if test="scheduleType != null">
            AND type = #{scheduleType}
        </if>
        limit #{batchJobSize}
    </select>

    <select id="countJobByCyctimeAndJobName" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM schedule_job bj
        WHERE cyc_time like '${preCycTime}%'
        AND job_name LIKE '${preJobName}%'
        AND is_deleted = 0
        <if test="scheduleType != null">
            AND type = #{scheduleType}
        </if>
    </select>

    <delete id="deleteByJobKey">
        delete from schedule_job
        where job_key in
        <foreach collection="jobKeyList" item="jobKey" open="(" separator="," close=")">
            #{jobKey}
        </foreach>
    </delete>

    <select id="listJobsByTaskIdAndApptype" resultType="ScheduleJob">
        select
        <include refid="select_content_fragment"/>
        from schedule_job bj
        where bj.task_id in
        <foreach collection="taskIds" item="taskId" close=")" open="(" separator="," >
            #{taskId}
        </foreach>
        and bj.app_type = #{appType}
    </select>


    <select id="getAllNodeAddress" resultType="java.lang.String">
        SELECT DISTINCT(node_address) as nodeAddress
        FROM schedule_job
        WHERE is_deleted = 0
    </select>


    <insert id="insert" parameterType="ScheduleJob" useGeneratedKeys="true" keyProperty="id">
	   INSERT INTO schedule_job
        (gmt_create, gmt_modified, tenant_id, project_id, dtuic_tenant_id, app_type, job_id, job_key, job_name, task_id,
        create_user_id, is_deleted, `type`, is_restart, business_date, cyc_time, dependency_type, flow_job_id,
        status, task_type, max_retry_num, retry_type, node_address, version_id, compute_type,period_type,business_type,resource_id,calender_id,next_cyc_time,job_build_type,job_execute_order)
	   VALUES
	   (now(), now(), #{tenantId}, #{projectId}, #{dtuicTenantId}, #{appType}, #{jobId}, #{jobKey}, #{jobName}, #{taskId},
	   #{createUserId}, #{isDeleted}, #{type}, #{isRestart}, #{businessDate}, #{cycTime}, #{dependencyType}, #{flowJobId},
	   #{status}, #{taskType}, #{maxRetryNum}, #{retryType}, #{nodeAddress}, #{versionId}, #{computeType},#{periodType},#{businessType},#{resourceId},#{calenderId},#{nextCycTime},#{jobBuildType},#{jobExecuteOrder})
    </insert>


    <update id="jobFinish">
        update schedule_job set exec_start_time = IFNULL(exec_start_time,now()), exec_end_time=now(), exec_time=timestampdiff(SECOND, exec_start_time, now()),gmt_modified=now(),status=#{status} where job_id=#{jobId};
    </update>

    <update id="updateJobStatus">
	   update schedule_job set gmt_modified=now(),status=#{status} where job_id=#{jobId};
   </update>

    <update id="updateTaskStatusNotStopped">
        update schedule_job set gmt_modified=now(),status=#{status} where job_id=#{jobId} and status not in
        <foreach item="stopStatus" index="index" collection="stopStatuses" open="(" separator="," close=")">
            #{stopStatus}
        </foreach>
    </update>

    <update id="updateJobSubmitSuccess">
	   update schedule_job
	   set engine_job_id=#{engineId}, application_id=#{appId},
	    gmt_modified=now(), exec_start_time=now()
	   where job_id=#{jobId};
   </update>

    <update id="updateJobAppId">
        update schedule_job
        set engine_job_id=#{engineId}, application_id=#{appId},
            gmt_modified=now()
        where job_id=#{jobId};
    </update>


    <update id="updateJobStatusAndExecTime">
	   update schedule_job set gmt_modified=now(), exec_end_time=now(), status=#{status}, exec_time=timestampdiff(SECOND, exec_start_time, now()) where job_id=#{jobId};
   </update>

    <select id="getRdosJobByJobId" resultType="ScheduleJob">
       select <include refid="select_filed_all"/> from schedule_job where job_id=#{jobId} and is_deleted=0 limit 1;
   </select>

    <select id="getRdosJobByJobIds" resultType="ScheduleJob">
        select id,job_id,task_id,app_type,engine_job_id,application_id,status,exec_start_time,exec_end_time,exec_time,retry_num,gmt_create,gmt_modified,is_deleted,compute_type,dtuic_tenant_id,cyc_time,task_type,resource_id,project_id,type
        from schedule_job
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted=0;
    </select>

    <select id="getDistinctProjectByJobIds" resultType="java.lang.Long">
        select distinct project_id
        from schedule_job
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted=0;
    </select>

    <select id="getSimpleInfoByJobIds" resultType="ScheduleJob">
        select job_id,job_key,job_name,task_id,app_type,status,cyc_time,flow_job_id,resource_id,type,task_type,is_restart
        from schedule_job
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted=0;
    </select>

    <select id="getByName" parameterType="java.lang.String" resultType="ScheduleJob">
        select <include refid="select_filed_all"/> from schedule_job where job_name = #{jobName} and is_deleted=0 LIMIT 1;
    </select>

    <update id="updateRetryNum">
	   update schedule_job set retry_num=#{retryNum}, gmt_modified=now() where job_id=#{jobId};
   </update>

    <select id="getJobIdsByStatus" resultType="java.lang.String">
        select job_id from schedule_job
        where status = #{status}
        <if test="computeType != null">
            and compute_type = #{computeType}
        </if>
        and is_deleted=0
    </select>

    <select id="listJobStatus" resultType="ScheduleJob">
        select <include refid="select_content_fragment"/>
        from schedule_job bj
        where bj.gmt_modified &gt;= #{time}
        <if test="computeType!=null">
            and bj.compute_type = #{computeType}
        </if>
        <if test="appType != null">
            and bj.app_type = #{appType}
        </if>
        and bj.is_deleted=0 and bj.status != 0
    </select>

    <select id="getListMinId" resultType="java.lang.Long">
        SELECT
            min(id)
        FROM schedule_job bj
        WHERE node_address = #{nodeAddress}
        <if test="scheduleType != null">
            AND type = #{scheduleType}
        </if>
        <if test="cycStartTime != null">
            AND cyc_time &gt;= #{cycStartTime}
        </if>
        <if test="cycEndTime != null">
            AND cyc_time &lt; #{cycEndTime}
        </if>
        <if test="isRestart != null">
            AND is_restart = #{isRestart}
        </if>
        AND (status = 0 or ((status = 10 or status=4) and task_type in (10, 14, 27)))
        AND is_deleted = 0
        AND `phase_status` = #{phaseStatus}
    </select>

    <update id="updateJobStatusByJobIds">
        update schedule_job
        set gmt_modified=now(), status=#{status}
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted=0;
    </update>
    <update id="updatePhaseStatusById">
        update `schedule_job`
        set `phase_status`=#{update}
        where `id` = #{id}
        and `phase_status` = #{original}
        and `is_deleted`=0;
    </update>
    <update id="updateListPhaseStatus">
        update `schedule_job`
        set `phase_status`=#{update}
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and `is_deleted`=0;
    </update>

    <update id="updateJobStatusAndPhaseStatus">
        update schedule_job set gmt_modified=now(),status=#{status},`phase_status` = #{phaseStatus},
        <if test="isRestart!=null">
            `is_restart` = #{isRestart},
        </if>
        <if test="nodeAddress!=null">
            node_address = #{nodeAddress},
        </if>
        application_id = null, engine_job_id = null, exec_end_time = null, exec_start_time = null, exec_time = 0, gmt_modified=now(),retry_num = 0
        where job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        <if test="oldStatus != null">
            AND status = #{oldStatus}
        </if>
        and `is_deleted`=0;
    </update>

    <update id="updateStatusByJobIdEqualsStatus">
        UPDATE schedule_job
        <set>
            <if test="updateStatus != null">
                status = #{updateStatus},
            </if>
            gmt_modified = now(),
            exec_start_time = now()
        </set>
        WHERE job_id = #{jobId} AND status = #{oldStatus}
        AND is_deleted=0
    </update>

    <update id="updateJobStatusAndPhaseStatusByIds">
        update schedule_job set
            `gmt_modified`=now(),
            `status`=#{status},
            `phase_status` = #{phaseStatus},
            `gmt_modified`=now()
        where job_id IN
        <foreach collection="jobIds" item="jobId" separator="," close=")" open="(" >
            #{jobId}
        </foreach>
    </update>
    <update id="updateFlowJob">
        update schedule_job set
        `gmt_modified`=now(),
        `flow_job_id` = #{flowJob}
        where `flow_job_id` = #{placeholder}
        and `is_deleted`=0
    </update>

    <select id="getLastScheduleJob" resultType="ScheduleJob">
        select
        <include refid="select_content_fragment"/>
        from schedule_job bj
        where bj.task_id = #{taskId}
        and bj.id &lt; ${id}
        order by id desc
        limit 1;
    </select>

    <select id="getFatherJob" resultType="ScheduleJob">
        SELECT <include refid="select_content_fragment"/>
         from `schedule_job` bj where job_key in (
           SELECT jj.parent_job_key FROM `schedule_job_job` jj, `schedule_job` j
            where jj.job_key = j.job_key
           and j.job_id = #{jobId} )
        and task_id = #{taskId} and app_type = #{appType} and is_deleted = 0 order by cyc_time limit 1
    </select>

    <select id="listJobByStatusAddressAndPhaseStatus"
            resultType="com.dtstack.engine.po.SimpleScheduleJobPO">
        SELECT id, job_id, type, phase_status
        FROM schedule_job
        WHERE id > #{startId} AND (node_address = #{nodeAddress} or node_address is null)
        <if test="statuses != null">
            AND status IN
            <foreach item="status" index="index" collection="statuses" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        AND is_deleted = 0
        AND `phase_status` = #{phaseStatus}
        order by id asc limit 500
    </select>

    <select id="getSubJobsAndStatusByFlowIdLimit" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE flow_job_id = #{jobId} AND is_deleted = 0 order by cyc_time desc LIMIT 1
    </select>
    <select id="alterPageList" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        <include refid="select_filed_all"/>
        FROM schedule_job
        WHERE
        is_deleted = 0
        AND app_type = #{appType}
        AND task_id IN
        <foreach item="taskId" collection="taskIds" open="(" separator="," close=")">
            #{taskId}
        </foreach>
        <if test="startCycTime !=null and engCycTime !=null">
            AND cyc_time &gt;= #{startCycTime}
            AND cyc_time &lt;= #{engCycTime}
        </if>
        <if test="projectId !=null">
            project_id = #{projectId}
        </if>
        LIMIT #{start},#{end}
    </select>


    <select id="getByTaskIdAndAppType" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE
        `id` > #{id}
        AND `task_id` = #{taskId}
        AND `app_type` = #{appType}
        order by id asc
        LIMIT #{limit}
    </select>

    <select id="pageFillDateCount" resultType="java.lang.Integer">
        SELECT count(bj.id)
        FROM schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        WHERE
        bj.app_type = #{dto.appType}
        AND ts.app_type = #{dto.appType}
        AND bj.dtuic_tenant_id =#{dto.dtuicTenantId}
        AND bj.project_id = #{dto.projectId}
        AND bj.fill_id = #{dto.fillId}
        <if test="dto.fillTypes !=null and dto.fillTypes.size !=0">
            AND bj.fill_type IN
            <foreach collection="dto.fillTypes" item="fillType" open="(" close=")" separator=",">
                #{fillType}
            </foreach>
        </if>
        <if test="dto.taskIds !=null and dto.taskIds.size !=0">
            AND bj.task_id IN
            <foreach collection="dto.taskIds" item="taskId" separator="," close=")" open="(" >
                #{taskId}
            </foreach>
        </if>
        <if test="dto.taskTypeList !=null and dto.taskTypeList.size() > 0" >
            AND bj.task_type IN
            <foreach item="taskType" index="index" collection="dto.taskTypeList" open="(" separator="," close=")">
                #{taskType}
            </foreach>
        </if>
        <if test="dto.jobStatusesList != null and dto.jobStatusesList.size() > 0">
            AND bj.status IN
            <foreach item="status" index="index" collection="dto.jobStatusesList" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        <if test="dto.cycStart!=null and dto.cycEnd">
            AND bj.cyc_time &gt;= #{dto.cycStart}
            AND bj.cyc_time &lt; #{dto.cycEnd}
        </if>
        <if test="dto.dutyUserId != null">
            AND ts.owner_user_id = #{dto.dutyUserId}
        </if>
        <if test="dto.resourceId != null">
            AND bj.resource_id = #{dto.resourceId}
        </if>
    </select>

    <select id="pageFillDate" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        FROM schedule_job bj
        LEFT JOIN schedule_task_shade ts ON bj.task_id = ts.task_id
        WHERE
        bj.app_type = #{dto.appType}
        AND ts.app_type = #{dto.appType}
        AND bj.dtuic_tenant_id =#{dto.dtuicTenantId}
        AND bj.project_id = #{dto.projectId}
        AND bj.fill_id = #{dto.fillId}
        <if test="dto.fillTypes !=null and dto.fillTypes.size !=0">
            AND bj.fill_type IN
            <foreach collection="dto.fillTypes" item="fillType" open="(" close=")" separator=",">
                #{fillType}
            </foreach>
        </if>
        <if test="dto.taskIds !=null and dto.taskIds.size !=0">
            AND bj.task_id IN
            <foreach collection="dto.taskIds" item="taskId" separator="," close=")" open="(" >
                #{taskId}
            </foreach>
        </if>
        <if test="dto.taskTypeList !=null and dto.taskTypeList.size() > 0" >
            AND bj.task_type IN
            <foreach item="taskType" index="index" collection="dto.taskTypeList" open="(" separator="," close=")">
                #{taskType}
            </foreach>
        </if>
        <if test="dto.jobStatusesList != null and dto.jobStatusesList.size() > 0">
            AND bj.status IN
            <foreach item="status" index="index" collection="dto.jobStatusesList" open="(" separator="," close=")">
                #{status}
            </foreach>
        </if>
        <if test="dto.cycStart!=null and dto.cycEnd">
            AND bj.cyc_time &gt;= #{dto.cycStart}
            AND bj.cyc_time &lt; #{dto.cycEnd}
        </if>
        <if test="dto.dutyUserId != null">
            AND ts.owner_user_id = #{dto.dutyUserId}
        </if>
        <if test="dto.resourceIds != null and dto.resourceIds.size()>0">
            AND bj.resource_id IN
            <foreach collection="dto.resourceIds" separator="," index="index" item="item" open="(" close=")">
                ${item}
            </foreach>
        </if>
        <trim prefix="ORDER BY " prefixOverrides=",">
            <if test="dto.execTimeSort != null and dto.execTimeSort != ''">
                , bj.exec_time ${dto.execTimeSort}
            </if>
            <if test="dto.execStartSort != null and dto.execStartSort != ''">
                , bj.exec_start_time ${dto.execStartSort}
            </if>
            <if test="dto.cycSort != null and dto.cycSort != ''">
                , bj.cyc_time ${dto.cycSort}
            </if>
            <if test="dto.businessDateSort != null and dto.businessDateSort != ''">
                , bj.business_date ${dto.businessDateSort}
            </if>
            <if test="dto.retryNumSort != null and dto.retryNumSort != ''">
                , bj.retry_num ${dto.retryNumSort}
            </if>
            , bj.gmt_create desc
        </trim>
        LIMIT #{dto.start} , #{dto.pageSize}
    </select>

    <update id="updateJobStatusAndExecTimeWithNodeAddress">
        update schedule_job set gmt_modified=now(), exec_end_time=now(), status=#{status}, exec_time=timestampdiff(SECOND, exec_start_time, now())
        where job_id=#{jobId} and node_address = #{nodeAddress};
    </update>

    <update id="updateJobStatusWithNodeAddress">
        update schedule_job set gmt_modified=now(),status=#{status} where job_id=#{jobId} and node_address = #{nodeAddress};
    </update>

    <update id="updateExecTimeAndStatusLogInfo">
        UPDATE
        schedule_job
        SET
        <if test="execStartTime != null">
            exec_start_time = #{execStartTime},
        </if>
        <if test="execEndTime != null">
            exec_end_time = #{execEndTime},
        </if>
        <if test="execTime != null">
            exec_time = #{execTime},
        </if>
        status = #{status},gmt_modified=now()
        WHERE job_id = #{jobId} AND is_deleted = 0
    </update>

    <update id="updateJobStatusANdExceTimeByIds">
        UPDATE schedule_job
        SET status = #{status},gmt_modified = now() ,exec_end_time=now() , exec_time=timestampdiff(SECOND, exec_start_time, now())
        WHERE is_deleted=0
        AND job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted=0;
    </update>

    <update id="updateResourceIdByProjectIdAndOldResourceIdAndStatus">
        UPDATE schedule_job
        SET resource_id = #{resourceId}, gmt_modified = now()
        WHERE project_id = #{projectId} and resource_id = #{oldResourceId} and status = #{status} and is_deleted=0;
    </update>

    <update id="updateResourceIdByTaskIdAndOldResourceIdAndStatus">
        UPDATE schedule_job
        SET resource_id = #{resourceId}, gmt_modified = now()
        WHERE task_id = #{taskId} and app_type = #{appType} and resource_id = #{oldResourceId} and status = #{status} and is_deleted=0;
    </update>
    <update id="updateResourceByTaskIds">
        update schedule_job set resource_id = #{resourceId}, gmt_modified = now()
        where dtuic_tenant_id = #{dtuicTenantId} and is_deleted = 0
        and task_id in
        <foreach item="id" index="index" collection="taskIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        and status in
        <foreach item="status" index="index" collection="statusList" open="(" separator="," close=")">
            #{status}
        </foreach>
        and app_type = #{appType};
    </update>

    <select id="listNoDeletedByJobIds" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
            <include refid="select_content_fragment"/>
          FROM schedule_job bj
        where job_id in
        <foreach collection="jobIds" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
         and is_deleted = 0
    </select>
    <select id="findTopEndRunTimeByTaskIdsAndAppType" resultType="java.sql.Timestamp">
        SELECT exec_end_time
        FROM schedule_job
        WHERE task_id =#{taskId}
        AND app_type = #{appType}
        AND exec_end_time is not null
        order by exec_end_time
        DESC LIMIT #{num};
    </select>

    <select id="selectJobByTaskIdAndJobExecuteOrder" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT `job_id`,`job_key`,`app_type`,`task_id` FROM schedule_job
        WHERE app_type = #{appType}
        AND task_id IN
        <foreach collection="taskIds" item="taskId" open="(" close=")" separator=",">
            #{taskId}
        </foreach>
        AND `type` = 0
        AND `job_execute_order` &gt;= #{start}
        AND `job_execute_order` &lt;= #{end}
        AND `is_deleted` = 0
        AND `flow_job_id` = 0
        <if test="cycTime!=null">
        AND `cyc_time` = #{cycTime}
        </if>
    </select>

    <select id="selectExecTimeByTaskIdAndAppType" resultType="java.lang.Integer">
        SELECT `exec_time`
        FROM schedule_job
        WHERE task_id =#{taskId}
        AND app_type = #{appType}
        AND status = #{status}
        AND exec_time is not null
        ORDER BY id DESC
        LIMIT #{maxBaselineJobNum};
    </select>

    <select id="selectJobByTaskIdAndApptype" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        <include refid="select_filed_all_bj"/>
        FROM schedule_job
        WHERE  is_deleted=0
        AND task_id IN
        <foreach collection="taskIds" separator="," item="taskId" close=")" open="(" >
            #{taskId}
        </foreach>
        AND type IN
        <foreach collection="types" separator="," item="type" close=")" open="(" >
            #{type}
        </foreach>
        AND app_type = #{appType}
        AND `job_execute_order` &gt;= #{range}
    </select>

    <select id="countByJobPageDTO" resultType="java.lang.Integer">
        SELECT count(id)
        FROM schedule_job
        WHERE  is_deleted = 0
        AND dtuic_tenant_id = #{dto.tenantId}
        AND project_id = #{dto.projectId}
        AND flow_job_id = '0'
        <include refid="queryByJobPageDTO"/>
    </select>

    <sql id="queryByJobPageDTO">
        <if test="dto.jobTimeDTO != null ">
            <if test="dto.jobTimeDTO.cycTimeStartTime != null
            and dto.jobTimeDTO.cycTimeStartTime.length!=0
            and dto.jobTimeDTO.cycTimeEndTime != null
            and dto.jobTimeDTO.cycTimeEndTime.length!=0">
                AND `cyc_time` &gt;= #{dto.jobTimeDTO.cycTimeStartTime}
                AND `cyc_time` &lt;= #{dto.jobTimeDTO.cycTimeEndTime}
            </if>
            <if test="dto.jobTimeDTO.cycTimeBussStartTime != null
            and dto.jobTimeDTO.cycTimeBussStartTime.length!=0
            and dto.jobTimeDTO.cycTimeBussEndTime != null
            and dto.jobTimeDTO.cycTimeBussEndTime.length!=0">
                AND `cyc_time` &gt;= #{dto.jobTimeDTO.cycTimeBussStartTime}
                AND `cyc_time` &lt;= #{dto.jobTimeDTO.cycTimeBussEndTime}
            </if>
        </if>
        <if test="dto.taskIds != null and dto.taskIds.size() > 0 " >
            AND task_id IN
            <foreach collection="dto.taskIds" separator="," item="taskId" close=")" open="(" >
                #{taskId}
            </foreach>
        </if>
        <if test="dto.jobIds != null and dto.jobIds.size() > 0">
            AND job_id IN
            <foreach collection="dto.jobIds" separator="," item="jobId" close=")" open="(" >
                #{jobId}
            </foreach>
        </if>
        <if test="dto.periodTypes != null and dto.periodTypes.size() > 0 ">
            AND period_type IN
            <foreach collection="dto.periodTypes" separator="," open="(" close=")" item="periodType">
                #{periodType}
            </foreach>
        </if>
        <if test="dto.resourceIds != null and dto.resourceIds.size() > 0 ">
            AND resource_id IN
            <foreach collection="dto.resourceIds" separator="," open="(" close=")" item="resourceId">
                #{resourceId}
            </foreach>
        </if>

        <if test="dto.types != null and dto.types.size() > 0 ">
            AND type IN
            <foreach collection="dto.types" separator="," open="(" close=")" item="type">
                #{type}
            </foreach>
        </if>
        <if test="dto.fillTypes !=null and dto.fillTypes.size() > 0 ">
            AND fill_type IN
            <foreach collection="dto.fillTypes" separator="," open="(" close=")" item="fillType">
                #{fillType}
            </foreach>
        </if>

        <if test="dto.type!=null">
            AND type = #{dto.type}
        </if>
        <if test="dto.fillId != null">
            AND fill_id =#{dto.fillId}
        </if>
        <if test="dto.fillId == null">
            AND app_type = #{dto.appType}
        </if>

    </sql>

    <select id="pageByJobPageDTO" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        `id`,
        `app_type`,
        `type`,
        `job_id`,
        `job_key`,
        `task_id`,
        `is_deleted`,
        `flow_job_id`,
        `cyc_time`,
        `period_type`,
        `status`,
        `task_type`,
        `exec_start_time`,
        `exec_end_time`,
        `exec_time`,
        `max_retry_num`,
        `retry_num`,
        `task_rule`,
        `resource_id`,
        `calender_id`
        FROM schedule_job
        WHERE  is_deleted = 0
        AND dtuic_tenant_id = #{dto.tenantId}
        AND project_id = #{dto.projectId}
        AND flow_job_id = '0'
        <if test="dto.jobTimeDTO != null ">
            <if test="dto.jobTimeDTO.cycTimeStartTime != null
                and dto.jobTimeDTO.cycTimeStartTime.length!=0
                and dto.jobTimeDTO.cycTimeEndTime != null
                and dto.jobTimeDTO.cycTimeEndTime.length!=0">
                AND `cyc_time` &gt;= #{dto.jobTimeDTO.cycTimeStartTime}
                AND `cyc_time` &lt;= #{dto.jobTimeDTO.cycTimeEndTime}
            </if>
            <if test="dto.jobTimeDTO.cycTimeBussStartTime != null
                and dto.jobTimeDTO.cycTimeBussStartTime.length!=0
                and dto.jobTimeDTO.cycTimeBussEndTime != null
                and dto.jobTimeDTO.cycTimeBussEndTime.length!=0">
                AND `cyc_time` &gt;= #{dto.jobTimeDTO.cycTimeBussStartTime}
                AND `cyc_time` &lt;= #{dto.jobTimeDTO.cycTimeBussEndTime}
            </if>
        </if>
        <if test="dto.taskIds != null and dto.taskIds.size() > 0 " >
            AND task_id IN
            <foreach collection="dto.taskIds" separator="," item="taskId" close=")" open="(" >
                #{taskId}
            </foreach>
        </if>
        <if test="dto.jobIds != null and dto.jobIds.size() > 0">
            AND job_id IN
            <foreach collection="dto.jobIds" separator="," item="jobId" close=")" open="(" >
                #{jobId}
            </foreach>
        </if>
        <if test="dto.periodTypes != null and dto.periodTypes.size() > 0 ">
            AND period_type IN
            <foreach collection="dto.periodTypes" separator="," open="(" close=")" item="periodType">
                #{periodType}
            </foreach>
        </if>
        <if test="dto.resourceIds != null and dto.resourceIds.size() > 0 ">
            AND resource_id IN
            <foreach collection="dto.resourceIds" separator="," open="(" close=")" item="resourceId">
                #{resourceId}
            </foreach>
        </if>
        <if test="dto.types != null and dto.types.size() > 0 ">
            AND type IN
            <foreach collection="dto.types" separator="," open="(" close=")" item="type">
                #{type}
            </foreach>
        </if>

        <if test="dto.fillTypes !=null and dto.fillTypes.size() > 0 ">
            AND fill_type IN
            <foreach collection="dto.fillTypes" separator="," open="(" close=")" item="fillType">
                #{fillType}
            </foreach>
        </if>

        <if test="dto.fillId != null">
            AND fill_id =#{dto.fillId}
        </if>
        <if test="dto.fillId == null">
            AND app_type = #{dto.appType}
        </if>
        ORDER BY
        <if test="dto.sort != null">
            <choose>
                <when test = "dto.sort.sortFiled == 1">
                    <if test="dto.sort.sortType == 1">
                        `business_date` asc
                    </if>
                    <if test="dto.sort.sortType == 2">
                        `business_date` desc
                    </if>
                </when>
                <when test = "dto.sort.sortFiled == 2">
                    <if test="dto.sort.sortType == 1">
                        `cyc_time` asc
                    </if>
                    <if test="dto.sort.sortType == 2">
                        `cyc_time` desc
                    </if>
                </when>
                <when test = "dto.sort.sortFiled == 3">
                    <if test="dto.sort.sortType == 1">
                        `exec_start_time` asc
                    </if>
                    <if test="dto.sort.sortType == 2">
                        `exec_start_time` desc
                    </if>
                </when>
                <when test = "dto.sort.sortFiled == 4">
                    <if test="dto.sort.sortType == 1">
                        `exec_end_time` asc
                    </if>
                    <if test="dto.sort.sortType == 2">
                        `exec_end_time` desc
                    </if>
                </when>
                <when test = "dto.sort.sortFiled == 5">
                    <if test="dto.sort.sortType == 1">
                        `exec_time` asc
                    </if>
                    <if test="dto.sort.sortType == 2">
                        `exec_time` desc
                    </if>
                </when>
                <when test = "dto.sort.sortFiled == 6">
                    <if test="dto.sort.sortType == 1">
                        `retry_num` asc
                    </if>
                    <if test="dto.sort.sortType == 2">
                        `retry_num` desc
                    </if>
                </when>
                <otherwise>
                    `gmt_create` desc
                </otherwise>
            </choose>
        </if>
        <if test="dto.sort == null">
            `gmt_create` desc
        </if>
        ,`id` desc
        LIMIT #{dto.start},#{dto.pageSize}
    </select>

    <select id="statusStatisticByJobPageVO" resultType="com.dtstack.engine.dto.StatusCount">
        SELECT status,count(status) as count
        FROM schedule_job
        WHERE  is_deleted = 0
        AND dtuic_tenant_id = #{dto.tenantId}
        AND project_id = #{dto.projectId}
        AND flow_job_id = '0'
        <if test="dto.jobTimeDTO != null ">
            <if test="dto.jobTimeDTO != null ">
                <if test="dto.jobTimeDTO.cycTimeStartTime != null
                        and dto.jobTimeDTO.cycTimeStartTime.length!=0
                        and dto.jobTimeDTO.cycTimeEndTime != null
                        and dto.jobTimeDTO.cycTimeEndTime.length!=0">
                    AND `cyc_time` &gt;= #{dto.jobTimeDTO.cycTimeStartTime}
                    AND `cyc_time` &lt;= #{dto.jobTimeDTO.cycTimeEndTime}
                </if>
                <if test="dto.jobTimeDTO.cycTimeBussStartTime != null
                        and dto.jobTimeDTO.cycTimeBussStartTime.length!=0
                        and dto.jobTimeDTO.cycTimeBussEndTime != null
                        and dto.jobTimeDTO.cycTimeBussEndTime.length!=0">
                    AND `cyc_time` &gt;= #{dto.jobTimeDTO.cycTimeBussStartTime}
                    AND `cyc_time` &lt;= #{dto.jobTimeDTO.cycTimeBussEndTime}
                </if>
            </if>
        </if>
        <if test="dto.taskIds != null and dto.taskIds.size() > 0 " >
            AND task_id IN
            <foreach collection="dto.taskIds" separator="," item="taskId" close=")" open="(" >
                #{taskId}
            </foreach>
        </if>
        <if test="dto.jobIds != null and dto.jobIds.size() > 0">
            AND job_id IN
            <foreach collection="dto.jobIds" separator="," item="jobId" close=")" open="(" >
                #{jobId}
            </foreach>
        </if>
        <if test="dto.periodTypes != null and dto.periodTypes.size() > 0 ">
            AND period_type IN
            <foreach collection="dto.periodTypes" separator="," open="(" close=")" item="periodType">
                #{periodType}
            </foreach>
        </if>
        <if test="dto.resourceIds != null and dto.resourceIds.size() > 0 ">
            AND resource_id IN
            <foreach collection="dto.resourceIds" separator="," open="(" close=")" item="resourceId">
                #{resourceId}
            </foreach>
        </if>

        <if test="dto.types != null and dto.types.size() > 0 ">
            AND type IN
            <foreach collection="dto.types" separator="," open="(" close=")" item="type">
                #{type}
            </foreach>
        </if>

        <if test="dto.fillTypes !=null and dto.fillTypes.size() > 0 ">
            AND fill_type IN
            <foreach collection="dto.fillTypes" separator="," open="(" close=")" item="fillType">
                #{fillType}
            </foreach>
        </if>
        <if test="dto.type!=null">
            AND type = #{dto.type}
        </if>
        <if test="dto.fillId != null">
            AND fill_id =#{dto.fillId}
        </if>
        <if test="dto.fillId == null">
            AND app_type = #{dto.appType}
        </if>
        GROUP BY status
    </select>

    <update id="updateByTaskIdAndVersionId">
        UPDATE schedule_job
         SET version_id = #{versionId}, gmt_modified = now()
        WHERE task_id = #{taskId} and app_type = #{appType} and version_id = #{oldVersionId} and status = #{status} and is_deleted = 0
    </update>

    <select id="getJobRangeByCycTime" resultType="ScheduleJob">
        SELECT
        <include refid="select_content_fragment"/>
        from schedule_job bj
        where task_id = #{taskId}
        AND app_type = #{appType}
        AND is_deleted = 0
        <if test="startTime != null and startTime != ''">
            AND bj.cyc_time <![CDATA[>=]]> #{startTime}
        </if>
        <if test="endTime != null and endTime != ''">
            AND bj.cyc_time <![CDATA[<]]> #{endTime}
        </if>
    </select>

    <select id="getSubJobsByFlowIdsAndQuery" resultType="ScheduleJob">
        SELECT <include refid="select_content_fragment"/>
        FROM schedule_job bj
        WHERE flow_job_id in
        <foreach item="id" index="index" collection="jobIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND flow_job_id != '0'
        AND is_deleted = 0
        <include refid="queryByJobPageDTO"/>
    </select>

    <select id="listByTimeAndStatus" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT
        task_id,app_type,job_id,status
        FROM schedule_job
        WHERE
        is_deleted = 0
        AND tenant_id = #{tenantId}
        AND project_id = #{projectId}
        AND app_type = #{appType}
        AND job_execute_order &gt;= #{start}
        AND resource_id = #{resourceId}
        AND status IN
        <foreach collection="statusList" open="(" close=")" item="status" separator=",">
            #{status}
        </foreach>
    </select>

    <select id="listFlowSubTaskIdByStatus" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT job_id,flow_job_id,task_type
        FROM schedule_job
        WHERE
        is_deleted = 0
        AND app_type = #{appType}
        AND dtuic_tenant_id = #{tenantId}
        AND project_id = #{projectId}
        <if test="jobTimeDTO != null ">
            <if test="jobTimeDTO.cycTimeStartTime != null
            and jobTimeDTO.cycTimeStartTime.length!=0
            and jobTimeDTO.cycTimeEndTime != null
            and jobTimeDTO.cycTimeEndTime.length!=0">
                AND `cyc_time` &gt;= #{jobTimeDTO.cycTimeStartTime}
                AND `cyc_time` &lt;= #{jobTimeDTO.cycTimeEndTime}
            </if>
            <if test="jobTimeDTO.cycTimeBussStartTime != null
            and jobTimeDTO.cycTimeBussStartTime.length!=0
            and jobTimeDTO.cycTimeBussEndTime != null
            and jobTimeDTO.cycTimeBussEndTime.length!=0">
                AND `cyc_time` &gt;= #{jobTimeDTO.cycTimeBussStartTime}
                AND `cyc_time` &lt;= #{jobTimeDTO.cycTimeBussEndTime}
            </if>
        </if>
        <if test="newJobStatuses != null and newJobStatuses.size() > 0 ">
            AND status IN
            <foreach collection="newJobStatuses" separator="," open="(" close=")" item="status">
                #{status}
            </foreach>
        </if>
        <if test="types != null and types.size() > 0 ">
            AND type IN
            <foreach collection="types" separator="," open="(" close=")" item="type">
                #{type}
            </foreach>
        </if>
        <if test="fillId != null">
            AND fill_id =#{fillId}
        </if>
    </select>
    <select id="listByFillAndRangCycTime" resultType="com.dtstack.engine.api.domain.ScheduleJob">
        SELECT job_id,status,cyc_time
        FROM schedule_job
        WHERE fill_id = #{fillId}
        AND cyc_time &gt;= #{startCycTime}
        AND cyc_time &lt; #{endCycTime}
        AND is_deleted = 0
    </select>

    <select id="listJobIdByJobIdAndStatus" resultType="java.lang.String">
        SELECT job_id
        FROM schedule_job
        WHERE
        is_deleted = 0
        <if test="jobIds !=null and jobIds.size() > 0">
            AND job_id IN
            <foreach collection="jobIds" separator="," item="jobId" close=")" open="(">
                #{jobId}
            </foreach>
        </if>
        <if test="statues!=null and statues.size() > 0">
            AND status IN
            <foreach collection="statues" open="(" close=")" item="status" separator="," >
                #{status}
            </foreach>
        </if>
    </select>

    <select id="getFillIdByJobIds" resultType="java.lang.Long">
        SELECT DISTINCT fill_id
        FROM schedule_job
        WHERE is_deleted = 0
        AND job_id IN
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
    </select>

    <select id="listByFillId" resultType="java.lang.String">
        SELECT job_id FROM schedule_job WHERE fill_id = #{fillId} and is_deleted = 0
    </select>

    <select id="listJobIdsByAppType" resultType="java.lang.String">
        SELECT job_id
        FROM schedule_job
        WHERE
        app_type = #{appType} and  is_deleted = 0
    </select>
</mapper>
