package com.dtstack.engine.master.multiengine;

import com.alibaba.testable.core.annotation.MockWith;
import com.dtstack.engine.master.mockcontainer.impl.SyncDataSourceMock;
import org.junit.Assert;
import org.junit.Test;

@MockWith(SyncDataSourceMock.class)
public class SyncDataSourceReplaceHandlerTest {
    SyncDataSourceReplaceHandler syncDataSourceReplaceHandler = new SyncDataSourceReplaceHandler();

    @Test
    public void testReplaceSync() throws Exception {
        String json = "{\"job\":{\"content\":[{\"reader\":{\"parameter\":{\"password\":\"192296\",\"customSql\":\"\",\"startLocation\":\"\",\"dtCenterSourceId\":22507,\"increColumn\":\"\",\"column\":[{\"name\":\"id\",\"type\":\"INT\",\"key\":\"id\"},{\"name\":\"NAME\",\"type\":\"VARCHAR\",\"key\":\"NAME\"},{\"name\":\"age\",\"type\":\"FLOAT\",\"key\":\"age\"},{\"name\":\"luck_value\",\"type\":\"DOUBLE\",\"key\":\"luck_value\"},{\"name\":\"create_date\",\"type\":\"TIMESTAMP\",\"key\":\"create_date\"},{\"name\":\"buss_date\",\"type\":\"DATE\",\"key\":\"buss_date\"}],\"connection\":[{\"schema\":\"db_test2\",\"password\":\"192296\",\"jdbcUrl\":[\"jdbc:mysql://1.13.194.13:3307/db_test2\"],\"table\":[\"test_246\"],\"username\":\"root\"}],\"sourceIds\":[5605],\"username\":\"root\"},\"name\":\"mysqlreader\"},\"writer\":{\"parameter\":{\"schema\":\"test_xxxxa\",\"fileName\":\"pt=${bdp.system.bizdate}\",\"dtCenterSourceId\":21905,\"column\":[{\"name\":\"id\",\"index\":0,\"type\":\"INT\",\"key\":\"id\"},{\"name\":\"NAME\",\"index\":1,\"type\":\"STRING\",\"key\":\"NAME\"},{\"name\":\"age\",\"index\":2,\"type\":\"FLOAT\",\"key\":\"age\"},{\"name\":\"luck_value\",\"index\":3,\"type\":\"DOUBLE\",\"key\":\"luck_value\"},{\"name\":\"create_date\",\"index\":4,\"type\":\"TIMESTAMP\",\"key\":\"create_date\"},{\"name\":\"buss_date\",\"index\":5,\"type\":\"DATE\",\"key\":\"buss_date\"}],\"writeMode\":\"overwrite\",\"encoding\":\"utf-8\",\"fullColumnName\":[\"id\",\"NAME\",\"age\",\"luck_value\",\"create_date\",\"buss_date\"],\"path\":\"hdfs://ns1/dtInsight/hive/warehouse/test_xxxxa.db/test_246\",\"partition\":\"pt=${bdp.system.bizdate}\",\"hadoopConfig\":{\"hive.exec.reducers.bytes.per.reducer\":\"64000000\",\"yarn.resourcemanager.zk-address\":\"172.16.85.215:2181,172.16.85.248:2181,172.16.85.253:2181\",\"dfs.replication\":\"3\",\"yarn.admin.acl\":\"*\",\"dfs.ha.fencing.ssh.private-key-files\":\"~/.ssh/id_rsa\",\"yarn.app.mapreduce.am.job.committer.cancel-timeout\":\"60000\",\"hive.exec.max.dynamic.partitions.pernode\":\"100\",\"dfs.ha.namenodes.ns1\":\"nn1,nn2\",\"yarn.resourcemanager.address.rm1\":\"172.16.85.215:8032\",\"dfs.namenode.avoid.read.stale.datanode\":\"FALSE\",\"dfs.journalnode.rpc-address\":\"0.0.0.0:8485\",\"yarn.resourcemanager.address.rm2\":\"172.16.85.248:8032\",\"yarn.scheduler.maximum-allocation-vcores\":\"4\",\"dfs.namenode.rpc-address.ns1.nn2\":\"172.16.85.248:9000\",\"hive.map.aggr\":\"true\",\"ipc.client.connection.maxidletime\":\"10000\",\"dfs.namenode.rpc-address.ns1.nn1\":\"172.16.85.215:9000\",\"yarn.resourcemanager.cluster-id\":\"yarn-rm-cluster\",\"hive.merge.mapfile\":\"true\",\"ha.health-monitor.sleep-after-disconnect.ms\":\"1000\",\"yarn.nodemanager.aux-services\":\"mapreduce_shuffle\",\"hadoop.util.hash.type\":\"murmur\",\"yarn.webapp.api-service.enable\":\"false\",\"dfs.hosts.exclude\":\"null\",\"dfs.namenode.replication.min\":\"1\",\"hive.server2.support.dynamic.service.discovery\":\"true\",\"yarn.nodemanager.container-manager.thread-count\":\"20\",\"dfs.datanode.directoryscan.threads\":\"1\",\"version\":\"2.7.6\",\"dfs.namenode.fs-limits.min-block-size\":\"1048576\",\"dfs.datanode.directoryscan.interval\":\"21600\",\"net.topology.script.number.args\":\"100\",\"hadoop.http.authentication.token.validity\":\"36000\",\"ha.failover-controller.graceful-fence.rpc-timeout.ms\":\"5000\",\"yarn.resourcemanager.nm.liveness-monitor.interval-ms\":\"1000\",\"dfs.namenode.datanode.registration.ip-hostname-check\":\"false\",\"hive.zookeeper.quorum\":\"172.16.85.215:2181,172.16.85.248:2181,172.16.85.253:2181\",\"yarn.nodemanager.localizer.cache.cleanup.interval-ms\":\"3600000\",\"dfs.client.file-block-storage-locations.num-threads\":\"10\",\"yarn.resourcemanager.scheduler.address.rm1\":\"172.16.85.215:8030\",\"yarn.resourcemanager.scheduler.address.rm2\":\"172.16.85.248:8030\",\"yarn.nodemanager.delete.debug-delay-sec\":\"600\",\"dfs.webhdfs.enabled\":\"true\",\"yarn.log-aggregation.retain-seconds\":\"604800\",\"dfs.namenode.avoid.write.stale.datanode\":\"FALSE\",\"fs.trash.interval\":\"4320\",\"yarn.scheduler.minimum-allocation-vcores\":\"1\",\"dfs.namenode.num.extra.edits.retained\":\"1000000\",\"ipc.client.connect.max.retries.on.timeouts\":\"45\",\"dfs.datanode.data.dir\":\"file:/data/hadoop/hdfs/data\",\"spark.executor.memory\":\"456340275B\",\"yarn.resourcemanager.resource-tracker.address.rm1\":\"172.16.85.215:8031\",\"yarn.resourcemanager.resource-tracker.address.rm2\":\"172.16.85.248:8031\",\"ha.health-monitor.connect-retry-interval.ms\":\"1000\",\"hive.server2.thrift.port\":\"10004\",\"yarn.nodemanager.env-whitelist\":\"JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,YARN_HOME\",\"yarn.resourcemanager.container.liveness-monitor.interval-ms\":\"600000\",\"dfs.client-write-packet-size\":\"65536\",\"dfs.journalnode.edits.dir\":\"/data/hadoop/hdfs/journal\",\"dfs.client.block.write.retries\":\"3\",\"yarn.nodemanager.linux-container-executor.cgroups.hierarchy\":\"/hadoop-yarn\",\"ha.failover-controller.graceful-fence.connection.retries\":\"1\",\"yarn.resourcemanager.recovery.enabled\":\"true\",\"dfs.namenode.safemode.threshold-pct\":\"0.999f\",\"yarn.nodemanager.disk-health-checker.enable\":\"true\",\"yarn.nodemanager.disk-health-checker.interval-ms\":\"120000\",\"hive.metastore.client.socket.timeout\":\"600s\",\"yarn.resourcemanager.admin.address.rm1\":\"172.16.85.215:8033\",\"yarn.log.server.url\":\"http://172.16.85.253:19888/jobhistory/logs/\",\"yarn.resourcemanager.admin.address.rm2\":\"172.16.85.248:8033\",\"dfs.datanode.dns.nameserver\":\"default\",\"javax.jdo.option.ConnectionDriverName\":\"com.mysql.jdbc.Driver\",\"yarn.resourcemanager.resource-tracker.client.thread-count\":\"50\",\"dfs.namenode.edits.journal-plugin.qjournal\":\"org.apache.hadoop.hdfs.qjournal.client.QuorumJournalManager\",\"yarn.nodemanager.delete.thread-count\":\"4\",\"dfs.nameservices\":\"ns1\",\"versionName\":\"Apache Hadoop 2.x\",\"dfs.safemode.threshold.pct\":\"0.5\",\"ipc.client.idlethreshold\":\"4000\",\"yarn.nodemanager.linux-container-executor.cgroups.mount-path\":\"/sys/fs/cgroup\",\"yarn.acl.enable\":\"FALSE\",\"dfs.client.failover.connection.retries.on.timeouts\":\"0\",\"hadoop.http.authentication.simple.anonymous.allowed\":\"true\",\"hadoop.security.authorization\":\"true\",\"hive.metastore.warehouse.dir\":\"/dtInsight/hive/warehouse\",\"hive.server2.webui.host\":\"172.16.85.248\",\"yarn.am.liveness-monitor.expiry-interval-ms\":\"600000\",\"yarn.nodemanager.linux-container-executor.resources-handler.class\":\"org.apache.hadoop.yarn.server.nodemanager.util.CgroupsLCEResourcesHandler\",\"yarn.resourcemanager.client.thread-count\":\"50\",\"spark.yarn.driver.memoryOverhead\":\"102000000\",\"dfs.image.compression.codec\":\"org.apache.hadoop.io.compress.DefaultCodec\",\"hadoop.security.authentication\":\"simple\",\"hive.metastore.uris\":\"thrift://172.16.85.248:9083\",\"hive.exec.dynamic.partition.mode\":\"nonstrict\",\"yarn.resourcemanager.max-completed-applications\":\"1000\",\"yarn.resourcemanager.ha.automatic-failover.enabled\":\"true\",\"yarn.nodemanager.linux-container-executor.cgroups.mount\":\"false\",\"yarn.log-aggregation-enable\":\"true\",\"hadoop.proxyuser.admin.hosts\":\"*\",\"yarn.resourcemanager.store.class\":\"org.apache.hadoop.yarn.server.resourcemanager.recovery.ZKRMStateStore\",\"yarn.app.mapreduce.am.job.task.listener.thread-count\":\"30\",\"hive.cluster.delegation.token.store.class\":\"org.apache.hadoop.hive.thrift.MemoryTokenStore\",\"dfs.namenode.support.allow.format\":\"true\",\"yarn.nodemanager.log.retain-seconds\":\"10800\",\"yarn.resourcemanager.ha.rm-ids\":\"rm1,rm2\",\"dfs.stream-buffer-size\":\"4096\",\"hadoop.proxyuser.admin.groups\":\"*\",\"yarn.nodemanager.container-executor.class\":\"org.apache.hadoop.yarn.server.nodemanager.LinuxContainerExecutor\",\"yarn.resourcemanager.scheduler.client.thread-count\":\"50\",\"dfs.bytes-per-checksum\":\"512\",\"dfs.datanode.max.transfer.threads\":\"8192\",\"ipc.maximum.data.length\":\"134217728\",\"yarn.app.mapreduce.am.job.client.port-range\":\"50100-50200\",\"ha.failover-controller.new-active.rpc-timeout.ms\":\"60000\",\"hive.merge.smallfiles.avgsize\":\"16000000\",\"hive.exec.reducers.max\":\"1099\",\"hive.fetch.task.conversion.threshold\":\"32000000\",\"hadoop.http.authentication.type\":\"simple\",\"yarn.scheduler.minimum-allocation-mb\":\"512\",\"hive.auto.convert.join.noconditionaltask.size\":\"20000000\",\"dfs.permissions.superusergroup\":\"supergroup\",\"io.seqfile.compress.blocksize\":\"1000000\",\"dfs.namenode.fs-limits.max-directory-items\":\"1048576\",\"yarn.resourcemanager.amliveliness-monitor.interval-ms\":\"1000\",\"yarn.nodemanager.pmem-check-enabled\":\"true\",\"yarn.nodemanager.remote-app-log-dir\":\"/tmp/logs\",\"dfs.blockreport.initialDelay\":\"0\",\"spark.executor.cores\":\"4\",\"yarn.scheduler.maximum-allocation-mb\":\"12288\",\"dfs.namenode.safemode.extension\":\"30000\",\"yarn.nodemanager.vmem-check-enabled\":\"false\",\"yarn.nodemanager.resource.percentage-physical-cpu-limit\":\"80\",\"fs.permissions.umask-mode\":\"022\",\"hive.reloadable.aux.jars.path\":\"/dtInsight/hive/udf\",\"ha.health-monitor.rpc-timeout.ms\":\"45000\",\"hive.server2.webui.max.threads\":\"50\",\"hive.exec.dynamic.partition\":\"true\",\"yarn.nodemanager.linux-container-executor.nonsecure-mode.limit-users\":\"true\",\"dfs.datanode.http.address\":\"0.0.0.0:60075\",\"yarn.nodemanager.linux-container-executor.nonsecure-mode.local-user\":\"admin\",\"yarn.nodemanager.linux-container-executor.group\":\"admin\",\"dfs.namenode.fs-limits.max-blocks-per-file\":\"1048576\",\"yarn.client.failover-proxy-provider\":\"org.apache.hadoop.yarn.client.ConfiguredRMFailoverProxyProvider\",\"dfs.client.block.write.replace-datanode-on-failure.enable\":\"TRUE\",\"yarn.nodemanager.remote-app-log-dir-suffix\":\"logs\",\"net.topology.node.switch.mapping.impl\":\"org.apache.hadoop.net.ScriptBasedMapping\",\"hive.merge.mapredfiles\":\"false\",\"hive.mapjoin.localtask.max.memory.usage\":\"0.9\",\"fs.df.interval\":\"60000\",\"spark.yarn.executor.memoryOverhead\":\"76000000\",\"yarn.nodemanager.resource.count-logical-processors-as-cores\":\"true\",\"ha.zookeeper.parent-znode\":\"/hadoop-ha\",\"hive.exec.max.dynamic.partitions\":\"1000\",\"yarn.nodemanager.resource.cpu-vcores\":\"12\",\"hive.server2.session.check.interval\":\"60000\",\"hive.server2.idle.operation.timeout\":\"6h\",\"yarn.log-aggregation.retain-check-interval-seconds\":\"604800\",\"dfs.https.enable\":\"FALSE\",\"dfs.permissions.enabled\":\"TRUE\",\"dfs.blockreport.split.threshold\":\"500000\",\"dfs.datanode.balance.bandwidthPerSec\":\"1048576\",\"ha.zookeeper.quorum\":\"172.16.85.215:2181,172.16.85.248:2181,172.16.85.253:2181\",\"hadoop.http.filter.initializers\":\"org.apache.hadoop.http.lib.StaticUserWebFilter\",\"ipc.server.read.threadpool.size\":\"1\",\"dfs.namenode.stale.datanode.interval\":\"60000\",\"yarn.resourcemanager.webapp.address.rm2\":\"172.16.85.248:18088\",\"yarn.resourcemanager.webapp.address.rm1\":\"172.16.85.215:18088\",\"yarn.app.mapreduce.client-am.ipc.max-retries\":\"3\",\"dfs.default.chunk.view.size\":\"32768\",\"typeName\":\"yarn2-hdfs2-hadoop2\",\"dfs.client.failover.proxy.provider.ns1\":\"org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider\",\"yarn.nodemanager.linux-container-executor.cgroups.strict-resource-usage\":\"false\",\"hive.merge.sparkfiles\":\"false\",\"yarn.resourcemanager.am.max-retries\":\"1\",\"dfs.namenode.handler.count\":\"64\",\"dfs.replication.max\":\"512\",\"io.bytes.per.checksum\":\"512\",\"dfs.namenode.name.dir\":\"file:/data/hadoop/hdfs/name\",\"yarn.app.mapreduce.client.max-retries\":\"3\",\"yarn.nodemanager.resource.memory-mb\":\"24576\",\"yarn.nodemanager.disk-health-checker.min-healthy-disks\":\"0.25\",\"dfs.datanode.failed.volumes.tolerated\":\"0\",\"ipc.client.kill.max\":\"10\",\"ipc.server.listen.queue.size\":\"128\",\"yarn.nodemanager.localizer.cache.target-size-mb\":\"10240\",\"yarn.resourcemanager.admin.client.thread-count\":\"1\",\"yarn.resourcemanager.scheduler.class\":\"org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler\",\"dfs.blocksize\":\"134217728\",\"storeType\":4,\"dfs.datanode.address\":\"0.0.0.0:50010\",\"security.job.submission.protocol.acl\":\"admin\",\"hive.map.aggr.hash.percentmemory\":\"0.5\",\"ha.failover-controller.cli-check.rpc-timeout.ms\":\"20000\",\"ipc.client.connect.max.retries\":\"10\",\"ha.zookeeper.acl\":\"world:anyone:rwcda\",\"dfs.namenode.write.stale.datanode.ratio\":\"0.5f\",\"hive.metastore.server.min.threads\":\"200\",\"hadoop.tmp.dir\":\"/data/hadoop_admin\",\"dfs.datanode.handler.count\":\"10\",\"md5zip\":\"91d9c99f8250d93c2b22780ed23c7853\",\"dfs.client.failover.max.attempts\":\"15\",\"yarn.resourcemanager.zk-state-store.address\":\"172.16.85.215:2181,172.16.85.248:2181,172.16.85.253:2181\",\"dfs.hosts\":\"null\",\"mapred.reduce.tasks\":\"-1\",\"yarn.resourcemanager.ha.automatic-failover.zk-base-path\":\"/yarn-leader-election\",\"hive.fetch.task.conversion\":\"minimal\",\"yarn.resourcemanager.ha.enabled\":\"true\",\"yarn.app.mapreduce.am.scheduler.heartbeat.interval-ms\":\"1000\",\"fs.trash.checkpoint.interval\":\"0\",\"dfs.journalnode.http-address\":\"0.0.0.0:18480\",\"yarn.nm.liveness-monitor.expiry-interval-ms\":\"600000\",\"dfs.datanode.fsdataset.volume.choosing.policy\":\"org.apache.hadoop.hdfs.server.datanode.fsdataset.AvailableSpaceVolumeChoosingPolicy\",\"ha.health-monitor.check-interval.ms\":\"1000\",\"hive.server2.async.exec.threads\":\"200\",\"spark.driver.memory\":\"966367641B\",\"dfs.blockreport.intervalMsec\":\"21600000\",\"hive.metastore.schema.verification\":\"false\",\"hive.metastore.connect.retries\":\"10\",\"mapreduce.job.hdfs-servers\":\"${fs.defaultFS}\",\"javax.jdo.option.ConnectionPassword\":\"DT@Stack#123\",\"io.native.lib.available\":\"TRUE\",\"dfs.image.compress\":\"FALSE\",\"yarn.nodemanager.webapp.address\":\"0.0.0.0:18042\",\"yarn.nodemanager.aux-services.mapreduce_shuffle.class\":\"org.apache.hadoop.mapred.ShuffleHandler\",\"dfs.datanode.dns.interface\":\"default\",\"hive.mapjoin.smalltable.filesize\":\"25000000L\",\"dfs.client.failover.connection.retries\":\"0\",\"hive.server2.webui.port\":\"10002\",\"hive.server2.thrift.min.worker.threads\":\"300\",\"fs.defaultFS\":\"hdfs://ns1\",\"yarn.nodemanager.disk-health-checker.max-disk-utilization-per-disk-percentage\":\"90\",\"dfs.namenode.fs-limits.max-component-length\":\"0\",\"dfs.ha.fencing.methods\":\"sshfence\",\"hive.server2.idle.session.check.operation\":\"true\",\"dfs.datanode.du.reserved\":\"20971520\",\"javax.jdo.option.ConnectionURL\":\"jdbc:mysql://172.16.85.248:3306/metastore?createDatabaseIfNotExist=true&useSSL=false&autoReconnect=true\",\"sftpConf\":{\"maxWaitMillis\":\"3600000\",\"minIdle\":\"16\",\"auth\":\"1\",\"isUsePool\":\"false\",\"timeout\":\"0\",\"path\":\"/data/sftp\",\"password\":\"dt@sz.com\",\"maxIdle\":\"16\",\"port\":\"22\",\"maxTotal\":\"16\",\"host\":\"172.16.100.251\",\"fileTimeout\":\"300000\",\"username\":\"root\"},\"dfs.datanode.ipc.address\":\"0.0.0.0:50020\",\"hive.merge.size.per.task\":\"256000000\",\"dfs.client.block.write.replace-datanode-on-failure.policy\":\"DEFAULT\",\"yarn.nodemanager.disk-health-checker.min-free-space-per-disk-mb\":\"10240\",\"dfs.namenode.shared.edits.dir\":\"qjournal://172.16.85.215:8485;172.16.85.248:8485;172.16.85.253:8485/namenode-ha-data\",\"javax.jdo.option.ConnectionUserName\":\"drpeco\",\"hive.mapjoin.followby.gby.localtask.max.memory.usage\":\"0.55\",\"dfs.namenode.name.dir.restore\":\"FALSE\",\"dfs.heartbeat.interval\":\"3\",\"ha.zookeeper.session-timeout.ms\":\"5000\",\"hive.server2.zookeeper.namespace\":\"hiveserver2\",\"hive.server2.enable.doAs\":\"false\",\"dfs.namenode.http-address.ns1.nn2\":\"172.16.85.248:60070\",\"dfs.namenode.http-address.ns1.nn1\":\"172.16.85.215:60070\",\"yarn.nodemanager.vmem-pmem-ratio\":\"4.1\",\"hive.exec.scratchdir\":\"/dtInsight/hive/warehouse\",\"hadoop.http.authentication.signature.secret.file\":\"/data/hadoop_base/etc/hadoop/hadoop-http-auth-signature-secret\",\"datanucleus.schema.autoCreateAll\":\"true\",\"hive.metastore.server.max.threads\":\"100000\",\"yarn.nodemanager.log-aggregation.compression-type\":\"none\",\"hive.server2.idle.session.timeout\":\"3600000\",\"dfs.ha.automatic-failover.enabled\":\"true\"},\"defaultFS\":\"hdfs://ns1\",\"connection\":[{\"jdbcUrl\":\"jdbc:hive2://172.16.85.248:10000/test_xxxxa\",\"table\":[\"test_246\"]}],\"table\":[\"test_246\"],\"fileType\":\"orc\",\"sourceIds\":[5499],\"username\":\"root\",\"fullColumnType\":[\"int\",\"string\",\"float\",\"double\",\"timestamp\",\"date\"]},\"name\":\"hdfswriter\"}}],\"setting\":{\"restore\":{\"maxRowNumForCheckpoint\":0,\"isRestore\":false,\"restoreColumnName\":\"\",\"restoreColumnIndex\":0},\"errorLimit\":{\"record\":100},\"speed\":{\"bytes\":1048576,\"channel\":1}}}}";
        String result = syncDataSourceReplaceHandler.replaceSync(json, "tes1");
        Assert.assertNotNull(result);
    }
}